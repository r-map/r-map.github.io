

<!DOCTYPE html>
<html class="writer-html5" lang="it" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Server RMAP &mdash; RMAP e Stima 3 documentazione</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Indice" href="../genindex.html" />
    <link rel="search" title="Cerca" href="../search.html" />
    <link rel="next" title="Videotutorial" href="../videotutorial/videotutorial.html" />
    <link rel="prev" title="Testa di prelievo per sensori Air Quality" href="../stima_wifi/testa_prelievo/testa_prelievo.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> RMAP e Stima
          

          
            
            <img src="../_static/logo_stima.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../rmap_rfc/rfc.html">RFC rmap versione 3.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../obsolete/index.html">Stima obsolete</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_v3/stima_v3.html">Stima V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_v4/stima_v4.html">Stima V4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_wifi/index.html">Stima WiFi</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Server RMAP</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#analisi-funzionalita-rmap">Analisi funzionalità RMAP</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduzione">Introduzione</a></li>
<li class="toctree-l3"><a class="reference internal" href="#data-ingestion">Data ingestion</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configurazione-delle-stazioni">Configurazione delle stazioni</a></li>
<li class="toctree-l3"><a class="reference internal" href="#registrazione-utenti">Registrazione utenti</a></li>
<li class="toctree-l3"><a class="reference internal" href="#visualizzazione-dei-dati">Visualizzazione dei dati</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cosudo">Cosudo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inserimento-manuale-dei-dati">Inserimento manuale dei dati</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rainbo">RainBO</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interfaccia-web">Interfaccia web</a></li>
<li class="toctree-l3"><a class="reference internal" href="#porte-utilizzate">Porte utilizzate</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#documentazione-implementazione">Documentazione implementazione</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#configurazione-stazioni">Configurazione stazioni</a></li>
<li class="toctree-l3"><a class="reference internal" href="#specifiche-per-immagini-georeferenziate">Specifiche per immagini georeferenziate</a></li>
<li class="toctree-l3"><a class="reference internal" href="#specifiche-per-file-di-configurazione-stazione">Specifiche per file di configurazione stazione</a></li>
<li class="toctree-l3"><a class="reference internal" href="#esempio-di-notification-json-rpc">Esempio di notification JSON-RPC</a></li>
<li class="toctree-l3"><a class="reference internal" href="#broker-mqtt">Broker MQTT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#generazione-dei-file-di-autenticazione-autorizzazione">Generazione dei file di autenticazione/autorizzazione</a></li>
<li class="toctree-l4"><a class="reference internal" href="#url">URL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#broker-amqp">Broker AMQP</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#definizione-nuovo-fornitore-o-consumatore-di-dati">Definizione nuovo fornitore o consumatore di dati</a></li>
<li class="toctree-l4"><a class="reference internal" href="#nomenclatura-convenzionale">Nomenclatura convenzionale</a></li>
<li class="toctree-l4"><a class="reference internal" href="#sistema-di-autenticazione-e-autorizzazione-di-rmap">Sistema di autenticazione e autorizzazione di RMAP</a></li>
<li class="toctree-l4"><a class="reference internal" href="#amqp-url-reference">URL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#log">Log</a></li>
<li class="toctree-l3"><a class="reference internal" href="#descrizione-applicazioni-django">Descrizione applicazioni Django</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#stations-app">stations app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#network-app">network app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http2mqtt-app">http2mqtt app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#firmware-updater-e-firmware-updater-stima-app">firmware_updater e firmware_updater_stima app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#geoimage-app">geoimage app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#rpc-app">rpc app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#ticket-app">ticket app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#borinud-app">borinud app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#graphite-dballe-app">graphite-dballe  app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#insertdata-app">insertdata app</a></li>
<li class="toctree-l4"><a class="reference internal" href="#showdata-app">showdata app</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#daemon">Daemon</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tools">Tools</a></li>
<li class="toctree-l3"><a class="reference internal" href="#struttura-cartelle">Struttura cartelle</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id28">Data ingestion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installazione-server-completo-basato-su-rocky-linux-8">Installazione server completo basato su  Rocky Linux 8</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#installazione-sistema-operativo">Installazione sistema operativo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#firewall">Firewall</a></li>
<li class="toctree-l3"><a class="reference internal" href="#postgresql">postgresql</a></li>
<li class="toctree-l3"><a class="reference internal" href="#apache">apache</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stunnel">Stunnel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#arkimet">Arkimet</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mosquitto">Mosquitto</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rabbitmq">Rabbitmq</a></li>
<li class="toctree-l3"><a class="reference internal" href="#monit">Monit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cron">Cron</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sincronizzazione-db-da-un-server">Sincronizzazione DB da un server</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#server-di-origine">Server di origine</a></li>
<li class="toctree-l4"><a class="reference internal" href="#server-di-destinazione">Server di destinazione</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#arkiweb">Arkiweb</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installazione-server-solo-funzionalita-data-ingestion-basato-su-rocky-linux-8">Installazione server solo funzionalità DATA INGESTION basato su  Rocky Linux 8</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">Installazione sistema operativo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id30">Mosquitto</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id31">Rabbitmq</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">Monit</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sincronizzazione-file-statici-per-autenticazione-e-autorizzazione-da-un-server-rmap-backend">Sincronizzazione file statici per autenticazione e autorizzazione da un server RMAP backend</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id33">Server di origine</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id34">Server di destinazione</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#installazione-server-rmap-solo-funzionalita-backend-basato-su-rocky-linux-8-a-seervizio-per-la-data-ingestion-su-un-altra-macchina">Installazione server RMAP solo funzionalità BACKEND basato su Rocky Linux 8 (a seervizio per la data ingestion su un'altra macchina)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#servizi">Servizi</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../videotutorial/videotutorial.html">Videotutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dispense/index.html">Dispense</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RMAP e Stima</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Server RMAP</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/server_rmap/server_rmap.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="server-rmap">
<h1>Server RMAP<a class="headerlink" href="#server-rmap" title="Link a questa intestazione">¶</a></h1>
<div class="section" id="analisi-funzionalita-rmap">
<h2>Analisi funzionalità RMAP<a class="headerlink" href="#analisi-funzionalita-rmap" title="Link a questa intestazione">¶</a></h2>
<div class="section" id="introduzione">
<h3>Introduzione<a class="headerlink" href="#introduzione" title="Link a questa intestazione">¶</a></h3>
<p>Le funzionalità offerte dal server RMAP
(<a class="reference external" href="https://rmap.cc/">https://rmap.cc</a>) sono implementate usando i
seguenti software e servizi (sono elencati solo quelli significativi):</p>
<ul class="simple">
<li><p>Broker AMQP (RabbitMQ) per la distribuzione di dati in tempo reale
attraverso un sistema di code, sia da stazione a server che da server
a server.</p></li>
<li><p>Broker MQTT (Mosquitto) per l’invio di dati da stazioni al server.</p></li>
<li><p>Arkimet per l’archiviazione dei dati storici</p></li>
<li><p>DB-All.e per l’archiviazione dei dati recenti</p></li>
<li><p>Una singola applicazione web (Django web framework) che gestisce</p>
<ul>
<li><p>Sistema di autenticazione</p></li>
<li><p>Visualizzazione dei dati</p></li>
<li><p>Registrazione utenti</p></li>
<li><p>Configurazione di metadati e firmware delle stazioni</p></li>
<li><p>Inserimento manuale dati e immagini georeferenziati</p></li>
<li><p>Visualizzazione personalizzata per RainBO</p></li>
</ul>
</li>
</ul>
<p><a class="reference internal" href="../_images/flussodati.png"><img alt="image0" src="../_images/flussodati.png" style="width: 16.51cm; height: 12.312cm;" /></a></p>
</div>
<div class="section" id="data-ingestion">
<span id="dataingestion-reference"></span><h3>Data ingestion<a class="headerlink" href="#data-ingestion" title="Link a questa intestazione">¶</a></h3>
<p>Il data ingestion riguarda principalmente l’accoglimento di dati da
stazioni via MQTT e AMQP. I dati che arrivano via MQTT sono poi
inoltrati al broker AMQP, che è il nucleo della movimentazione dei dati
all’interno del sistema. I client che devono inviare dati via MQTT o
AMQP devono passare da un sistema di autenticazione e autorizzazione,
sostanzialmente per garantire che i dati siano inviati solo da utenti
autenticati e che non vadano a sovrapporsi a dati altrui. Entrambi i
broker interrogano il sistema di autenticazione<strong>,</strong> un servizio web
che implementa gli endpoint richiesti da RabbitMQ e Mosquitto. Il
servizio di autorizzazione su AMQP (cioè cosa può pubblicare un utente
autenticato) è invece delegato al demone <em>identvalidationd</em>, che prende
i dati dalla coda di ingresso dell’utente e passa alla coda di ingestion
solo i dati per cui il campo ident è uguale al nome utente. I dati che
passano quest’ultimo controllo sono poi inviati:</p>
<ul class="simple">
<li><p>Ad altre code AMQP, ad esempio per forniture esterne o per altri
processamenti. Su due di queste code sono inoltrati i dati per il
SIMC (archiviati in Arkimet in formato VM2), una per le stazioni
delle reti <em>claster</em> e <em>rmap</em> e l’altra per la rete <em>profe</em>.</p></li>
<li><p>Al database DB-All.e che contiene i dati recenti.</p></li>
</ul>
<p>Ci sono inoltre alcuni moduli per l’accoglimento di dati da sorgenti che
non usano AMQP o non usano il formato BUFR (e.g. Luftdaten).</p>
<p><a class="reference internal" href="../_images/dataingestion.png"><img alt="image1" src="../_images/dataingestion.png" style="width: 16.51cm; height: 16.016cm;" /></a></p>
</div>
<div class="section" id="configurazione-delle-stazioni">
<span id="configurazionestazioni-reference"></span><h3>Configurazione delle stazioni<a class="headerlink" href="#configurazione-delle-stazioni" title="Link a questa intestazione">¶</a></h3>
<p>Questa funzionalità permette l’aggiornamento della configurazione e del
firmware delle stazioni STIMA. L’aggiornamento può essere fatto via HTTP
o AMQP, previa autenticazione presso il corrispondente servizio di
autenticazione.
<a class="reference internal" href="../_images/stationmanager.png"><img alt="image2" src="../_images/stationmanager.png" style="width: 16.51cm; height: 10.372cm;" /></a></p>
</div>
<div class="section" id="registrazione-utenti">
<span id="registrazioneutenti-reference"></span><h3>Registrazione utenti<a class="headerlink" href="#registrazione-utenti" title="Link a questa intestazione">¶</a></h3>
<p>Questa funzionalità permette di registrare gli utenti attraverso un
classico processo di iscrizione: l’utente compila una form e riceve una
email per la conferma dell’avvenuta registrazione. Ovviamente, c’è un
dialogo con il servizio di autenticazione.
<a class="reference internal" href="../_images/registrazione_utenti.png"><img alt="image3" src="../_images/registrazione_utenti.png" style="width: 16.51cm; height: 12.136cm;" /></a></p>
</div>
<div class="section" id="visualizzazione-dei-dati">
<span id="visualizzazionedati-reference"></span><h3>Visualizzazione dei dati<a class="headerlink" href="#visualizzazione-dei-dati" title="Link a questa intestazione">¶</a></h3>
<p>Questo servizio permette di visualizzare i dati archiviati (DB-All.e e
Arkimet) sia su mappa che su grafico. Non c’è servizio di autenticazione
e autorizzazione perchè si presuppone che tutti i dati siano pubblici.
Questo sistema è probabilmente necessario per i dati della rete
amatoriale e quindi è necessario che il servizio corrispondente di data
ingestion sia collegato all’importatore dei dati su DB-All.e e Arkimet.
<a class="reference internal" href="../_images/borinud_showdata.png"><img alt="image4" src="../_images/borinud_showdata.png" style="width: 16.51cm; height: 7.938cm;" /></a></p>
</div>
<div class="section" id="cosudo">
<span id="cosudo-reference"></span><h3>Cosudo<a class="headerlink" href="#cosudo" title="Link a questa intestazione">¶</a></h3>
<p>Cosudo permette di analizzare i dati osservati per identificare
anomalie, confrontando i dati da stazione con dati radar, satellite e
previsti. Inoltre, permette all’operatore di invalidare dei dati: tali
invalidazioni sono poi inviate ai sistemi del SIMC per applicarle
sull’archivio.</p>
<p>È una applicazione che non necessita di accesso dall’esterno e deve
avere a disposizione i dati dall’archivio del SIMC.</p>
<p>Il sistema di autenticazione è necessario poiché, essendo ospitato sul
server rmap.cc, deve essere reso privato.</p>
<p>Non è ancora operativo e mancano i flussi di alimentazione dei dati.
<a class="reference internal" href="../_images/cosudo.png"><img alt="image5" src="../_images/cosudo.png" style="width: 16.51cm; height: 15.84cm;" /></a></p>
</div>
<div class="section" id="inserimento-manuale-dei-dati">
<span id="inserimentomanuale-reference"></span><h3>Inserimento manuale dei dati<a class="headerlink" href="#inserimento-manuale-dei-dati" title="Link a questa intestazione">¶</a></h3>
<p>Questa funzionalità permette l’inserimento manuale, da parte di
operatori, di dati e immagini via HTTP e AMQP. I dati attualmente sono
le osservazioni della neve e del tempo (quest’ultimo all’interno del
progetto RainBO). Si appoggia al sistema di autenticazione.
<a class="reference internal" href="../_images/insertdata_geoimage.png"><img alt="image6" src="../_images/insertdata_geoimage.png" style="width: 16.51cm; height: 9.102cm;" /></a></p>
</div>
<div class="section" id="rainbo">
<span id="raindo-reference"></span><h3>RainBO<a class="headerlink" href="#rainbo" title="Link a questa intestazione">¶</a></h3>
<p>È l’interfaccia per un progetto, che permette la visualizzazione con
delle viste personalizzate per i seguenti servizi:</p>
<ul class="simple">
<li><p>Visualizzazione dei dati</p></li>
<li><p>Inserimento manuale dei dati</p></li>
<li><p>Registrazione utenti</p></li>
</ul>
</div>
<div class="section" id="interfaccia-web">
<span id="interfacciaweb-reference"></span><h3>Interfaccia web<a class="headerlink" href="#interfaccia-web" title="Link a questa intestazione">¶</a></h3>
<p>L’accesso da browser al sistema per alcune funzionalità, quali</p>
<ul class="simple">
<li><p>Registrazione utente</p></li>
<li><p>Configurazione manuale delle stazioni</p></li>
<li><p>Visualizzazione dati</p></li>
<li><p>Inserimento manuale di dati</p></li>
</ul>
<p>Sono offerte da un sistema monolitico, in cui tutti i vari pezzi sono
interconnessi. È possibile separarli, ma è richiesto un intervento non
banale sul frontend che può essere eseguito solo a valle
dell’organizzazione dei vari pezzi di RMAP su diversi host.</p>
<p>Se una funzionalità usa varie app Django e deve quindi “assemblare”
varie interfacce insieme, allora è necessario fare un repository per la
singola funzionalità che dipende dalle app Django richieste.</p>
</div>
<div class="section" id="porte-utilizzate">
<h3>Porte utilizzate<a class="headerlink" href="#porte-utilizzate" title="Link a questa intestazione">¶</a></h3>
<table class="docutils align-default">
<colgroup>
<col style="width: 7%" />
<col style="width: 22%" />
<col style="width: 8%" />
<col style="width: 29%" />
<col style="width: 9%" />
<col style="width: 15%" />
<col style="width: 10%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>porta</p></th>
<th class="head"><p>protocollo</p></th>
<th class="head"><p>server</p></th>
<th class="head"><p>servizio</p></th>
<th class="head"><p>RMAP server</p></th>
<th class="head"><p>RMAP data ingestion</p></th>
<th class="head"><p>RMAP backend</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>80</p></td>
<td><p>HTTP</p></td>
<td><p>apache</p></td>
<td><p>download conf e firmware (Stima V3)</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-odd"><td><p>442</p></td>
<td><p>HTTPS TLS con pre shared Key</p></td>
<td><p>stunnel</p></td>
<td><p>download conf e firmware (Stima v4)</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-even"><td><p>443</p></td>
<td><p>HTTPS  (SSL/TLS)</p></td>
<td><p>apache</p></td>
<td><p>gestione backend e visualizzazione dati</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-odd"><td><p>5925</p></td>
<td><p>HTTP</p></td>
<td><p>monit</p></td>
<td><p>monitoraggio daemoni RMAP</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-even"><td><p>1883</p></td>
<td><p>MQTT</p></td>
<td><p>mosquitto</p></td>
<td><p>pubblicazioni dati stazione (Stima V3)</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>5671</p></td>
<td><p>AMQPS  (SSL/TLS)</p></td>
<td><p>rabbit-mq</p></td>
<td><p>pubblicazione e distribuzione dati</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>5672</p></td>
<td><p>AMQP</p></td>
<td><p>rabbit-mq</p></td>
<td><p>pubblicazione e distribuzione dati</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>8883</p></td>
<td><p>MQTTS TLS con pre shared Key</p></td>
<td><p>mosquitto</p></td>
<td><p>pubblicazione stazioni (Stima V4)</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>8884</p></td>
<td><p>MQTTS (SSL/TLS) WEBSOCKET</p></td>
<td><p>mosquitto</p></td>
<td><p>monitoraggio MQTT da web</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>15672</p></td>
<td><p>HTTP</p></td>
<td><p>rabbit-mq</p></td>
<td><p>Management Plugin</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="documentazione-implementazione">
<h2>Documentazione implementazione<a class="headerlink" href="#documentazione-implementazione" title="Link a questa intestazione">¶</a></h2>
<p>Il funzionamento del back-end e del front-end è basato su due broker,
una suite di applicazioni Django, alcuni tools e da una suite di daemon.</p>
<div class="section" id="configurazione-stazioni">
<h3>Configurazione stazioni<a class="headerlink" href="#configurazione-stazioni" title="Link a questa intestazione">¶</a></h3>
<p>Le configurazioni risiedono sul server. Possono essere scaricate e uplodate sul server.
Le configurazioni devono essere trasferite alle stazioni e devono sempre essere allineate.
Le stazioni Stima si possono configurare con i seguenti formati e trasporti:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 28%" />
<col style="width: 17%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 8%" />
<col style="width: 19%" />
</colgroup>
<tbody>
<tr class="row-odd"><td></td>
<td><p>trasporto
Seriale</p></td>
<td><p>trasporto
HTTP</p></td>
<td><p>tasporto
http PSK</p></td>
<td><p>SD
card</p></td>
<td><p>download/upload
server</p></td>
</tr>
<tr class="row-even"><td><p>JSON-RPC</p></td>
<td><p>#</p></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>notification JSON-RPC</p></td>
<td></td>
<td><p>#</p></td>
<td><p>#</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>dump DB in json</p></td>
<td></td>
<td><p>#</p></td>
<td></td>
<td></td>
<td><p>#</p></td>
</tr>
<tr class="row-odd"><td><p>file binario</p></td>
<td></td>
<td></td>
<td></td>
<td><p>#</p></td>
<td></td>
</tr>
</tbody>
</table>
<p>queste configurazioni sono utilizzate differentemente a seconda del
modello di stazione:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 15%" />
<col style="width: 13%" />
<col style="width: 31%" />
<col style="width: 23%" />
<col style="width: 19%" />
</colgroup>
<tbody>
<tr class="row-odd"><td></td>
<td><p>JSON-RPC</p></td>
<td><p>notification JSON-RPC</p></td>
<td><p>dump DB in json</p></td>
<td><p>file binario</p></td>
</tr>
<tr class="row-even"><td><p>StimaWifi</p></td>
<td></td>
<td></td>
<td><p>#</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>Stima V3</p></td>
<td><p>#</p></td>
<td></td>
<td></td>
<td><p>#</p></td>
</tr>
<tr class="row-even"><td><p>Stima V4</p></td>
<td><p>#</p></td>
<td><p>#</p></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="specifiche-per-immagini-georeferenziate">
<h3>Specifiche per immagini georeferenziate<a class="headerlink" href="#specifiche-per-immagini-georeferenziate" title="Link a questa intestazione">¶</a></h3>
<p>Le immagini devono essere in formato jpeg e usare exif per i metadati.</p>
<p>Vengono utilizzati i seguenti metadati:</p>
<ul class="simple">
<li><p>Latitude/Longitude (GPSIFD.GPSLatitude/GPSIFD.GPSLongitude)</p></li>
<li><p>reftime            (ImageIFD.DateTime)</p></li>
<li><p>imagedescription   (ImageIFD.ImageDescription)</p></li>
<li><p>usercomment        (ExifIFD.UserComment)</p></li>
</ul>
</div>
<div class="section" id="specifiche-per-file-di-configurazione-stazione">
<h3>Specifiche per file di configurazione stazione<a class="headerlink" href="#specifiche-per-file-di-configurazione-stazione" title="Link a questa intestazione">¶</a></h3>
<p>Il file è un dump in json del DB usato da Django relativo solo alle
tabelle di interesse per la configurazione. Questo un esempio:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.stationmetadata&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;paperino&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;ident&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="mf">44.48858</span><span class="p">,</span>
    <span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="mf">11.37099</span><span class="p">,</span>
    <span class="s2">&quot;network&quot;</span><span class="p">:</span> <span class="s2">&quot;fixed&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mqttrootpath&quot;</span><span class="p">:</span> <span class="s2">&quot;sample&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mqttmaintpath&quot;</span><span class="p">:</span> <span class="s2">&quot;maint&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;good&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;stimav2&quot;</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.board&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="s2">&quot;template&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;sn&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;stationmetadata&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;paperino&quot;</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.sensor&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Dust&quot;</span><span class="p">,</span>
    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;SPS&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;i2cbus&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">105</span><span class="p">,</span>
    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;timerange&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;103,2000,-,-&quot;</span><span class="p">,</span>
    <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;default&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
        <span class="p">[</span>
          <span class="s2">&quot;paperino&quot;</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.sensor&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Temperature_Humidity&quot;</span><span class="p">,</span>
    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;SHT&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;i2cbus&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span>
    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;timerange&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;103,2000,-,-&quot;</span><span class="p">,</span>
    <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;default&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
        <span class="p">[</span>
          <span class="s2">&quot;paperino&quot;</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.sensor&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;CO2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;SCD&quot;</span>
    <span class="p">],</span>
    <span class="s2">&quot;i2cbus&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">97</span><span class="p">,</span>
    <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;timerange&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0&quot;</span><span class="p">,</span>
    <span class="s2">&quot;level&quot;</span><span class="p">:</span> <span class="s2">&quot;103,2000,-,-&quot;</span><span class="p">,</span>
    <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;default&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
        <span class="p">[</span>
          <span class="s2">&quot;paperino&quot;</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.transportmqtt&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;mqttsampletime&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
    <span class="s2">&quot;mqttserver&quot;</span><span class="p">:</span> <span class="s2">&quot;test.rmap.it&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mqttuser&quot;</span><span class="p">:</span> <span class="s2">&quot;paperino&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mqttpassword&quot;</span><span class="p">:</span> <span class="s2">&quot;wFCeWf4ZqY&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mqttpskkey&quot;</span><span class="p">:</span> <span class="s2">&quot;648A67186FBF033E8A508282EEA74767&quot;</span><span class="p">,</span>
    <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;default&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
        <span class="p">[</span>
          <span class="s2">&quot;paperino&quot;</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.transporttcpip&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;stima&quot;</span><span class="p">,</span>
    <span class="s2">&quot;ntpserver&quot;</span><span class="p">:</span> <span class="s2">&quot;it.pool.ntp.org&quot;</span><span class="p">,</span>
    <span class="s2">&quot;gsmapn&quot;</span><span class="p">:</span> <span class="s2">&quot;ibox.tim.it&quot;</span><span class="p">,</span>
    <span class="s2">&quot;pppnumber&quot;</span><span class="p">:</span> <span class="s2">&quot;*99#&quot;</span><span class="p">,</span>
    <span class="s2">&quot;board&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;default&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
        <span class="p">[</span>
          <span class="s2">&quot;paperino&quot;</span>
        <span class="p">]</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.stationconstantdata&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;btable&quot;</span><span class="p">:</span> <span class="s2">&quot;B01019&quot;</span><span class="p">,</span>
    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stationmetadata&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;paperino&quot;</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
  <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;stations.stationconstantdata&quot;</span><span class="p">,</span>
  <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">,</span>
    <span class="s2">&quot;btable&quot;</span><span class="p">:</span> <span class="s2">&quot;B07030&quot;</span><span class="p">,</span>
    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;400&quot;</span><span class="p">,</span>
    <span class="s2">&quot;stationmetadata&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span>
      <span class="p">[</span>
        <span class="s2">&quot;paperino&quot;</span>
      <span class="p">]</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="esempio-di-notification-json-rpc">
<h3>Esempio di notification JSON-RPC<a class="headerlink" href="#esempio-di-notification-json-rpc" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;B01019&quot;</span><span class="p">:</span> <span class="s2">&quot;stimawifi&quot;</span><span class="p">}}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;sd&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;B07030&quot;</span><span class="p">:</span> <span class="s2">&quot;400&quot;</span><span class="p">}}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttrootpath&quot;</span><span class="p">:</span> <span class="s2">&quot;1/sample/paperino//1137099,4448858/fixed/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttmaintpath&quot;</span><span class="p">:</span> <span class="s2">&quot;1/maint/paperino//1137099,4448858/fixed/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttrpcpath&quot;</span><span class="p">:</span> <span class="s2">&quot;1/rpc/paperino//1137099,4448858/fixed/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttsampletime&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="s2">&quot;mqttserver&quot;</span><span class="p">:</span> <span class="s2">&quot;test.rmap.it&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttuser&quot;</span><span class="p">:</span> <span class="s2">&quot;paperino&quot;</span><span class="p">,</span> <span class="s2">&quot;mqttpassword&quot;</span><span class="p">:</span> <span class="s2">&quot;77CeWf4ZqY&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;mqttpskkey&quot;</span><span class="p">:</span> <span class="s2">&quot;0x328467156FBF033E8A508282EEA74767&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;stationslug&quot;</span><span class="p">:</span> <span class="s2">&quot;stimawifi&quot;</span><span class="p">,</span> <span class="s2">&quot;boardslug&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;ntpserver&quot;</span><span class="p">:</span> <span class="s2">&quot;it.pool.ntp.org&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;gsmapn&quot;</span><span class="p">:</span> <span class="s2">&quot;ibox.tim.it&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SPS&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">105</span><span class="p">,</span> <span class="s2">&quot;mqttpath&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0/103,2000,-,-/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SHT&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">68</span><span class="p">,</span> <span class="s2">&quot;mqttpath&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0/103,2000,-,-/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;driver&quot;</span><span class="p">:</span> <span class="s2">&quot;I2C&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;SCD&quot;</span><span class="p">,</span> <span class="s2">&quot;node&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">:</span> <span class="mi">97</span><span class="p">,</span> <span class="s2">&quot;mqttpath&quot;</span><span class="p">:</span> <span class="s2">&quot;254,0,0/103,2000,-,-/&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;configure&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;save&quot;</span><span class="p">:</span> <span class="n">true</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span> <span class="s2">&quot;2.0&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;reboot&quot;</span><span class="p">}</span>
<span class="p">{</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">:</span><span class="s2">&quot;2.0&quot;</span><span class="p">,</span><span class="s2">&quot;result&quot;</span><span class="p">:{},</span><span class="s2">&quot;id&quot;</span><span class="p">:</span><span class="mi">0</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="broker-mqtt">
<h3>Broker MQTT<a class="headerlink" href="#broker-mqtt" title="Link a questa intestazione">¶</a></h3>
<p>Le stazioni Stima comunicano i dati al broker differentemente a
seconda della versione:</p>
<ul class="simple">
<li><p><strong>stazioni StimaWiFi</strong>: comunicano in WiFi in chiaro, tramite
protocollo MQTT</p></li>
<li><p><strong>stazioni Stima V3</strong>: comunicano in GSM in chiaro, tramite
protocollo MQTT</p></li>
<li><p><strong>stazioni Stima V4</strong>: comunicano in TLS con PSK (Pre-Shared Key),
tramite protocollo MQTTS (PSK)</p></li>
</ul>
<p>Il broker MQTT (mosquitto) authentica e autorizza tramite un apposito
plugin.  Utilizza l'hash delle password utente, le chiavi PSK, le ACL;
queste vengono ottenute da file o da un server di autenticazione
tramite API http.  La generazione del file se necessario piò essere
fatta con il tool rmapctrl.</p>
<p>Mosquitto comunica tramite un terzo protocollo, MQTT con SSL/TLS su
Websocket utilizzato per funzionalità di monitoraggio delle stazioni
meteo; tramite javascript nel web browser.  Gli operatori che
gestiscono le varie stazioni meteo possono attivare il monitoraggio su
websocket per verificare i messaggi pubblicati dalla stazione sul
broker evitando la necessità di avere un apposito client MQTT.</p>
<p>E’ presente anche un altro demone (<strong>report2observationd</strong>) che
effettua una trasformazione dei messaggi che arrivano inizialmente
compressi (vedi forme compresse protocollo RMAP over MQTT), li
decomprime e li pubblica nuovamente, per cui arrivano sul broker MQTT
in forma decompressa.</p>
<p>Ogni stazione può pubblicare solamente sul topic mqtt per cui è stata
configurata e quindi autorizzata, in base a utente, rete, latitudine e
longitudine. Ogni autenticazione e autorizzazione corrisponde a una
richiesta http, ma con apposita cache del plugin di mosquitto.</p>
<p>Il plugin di mosquitto è una versione appositamente modificata:
<a class="reference external" href="https://github.com/r-map/mosquitto-auth-plug">https://github.com/r-map/mosquitto-auth-plug</a></p>
<p>Se configurato a tale scopo il broker alle richieste di
autenticazione/autorizzazione, nel caso in cui non sia disponibile il
servizio http ricade su un file statico. Quando la configurazione
hardware lo indichi come opportuno (separazione fisica della data
ingestion) il file statico, utilizzato come sistema di autenticazione
di backup, deve essere sincronizzato tramite procedura schedulata dal
server di backend verso il server di data ingestion in modo da
consentire comunque l’autenticazione delle stazioni anche in caso di
failure del backend (il sistema non consentirà per esempio l’aggiunta
o lo spostamento di stazioni ma non si bloccherà la pubblicazione dei
dati).</p>
<p>I dati, una volta autenticate le stazioni sul backend e pubblicati
tramite il broker MQTT sono disponibili ai subscriber, principalmente
ai daemoni per la conversione di formato e l'invio come messaggi AMQP.</p>
<div class="section" id="generazione-dei-file-di-autenticazione-autorizzazione">
<h4>Generazione dei file di autenticazione/autorizzazione<a class="headerlink" href="#generazione-dei-file-di-autenticazione-autorizzazione" title="Link a questa intestazione">¶</a></h4>
<p>Per mantenere allineato il processo di autenticazione sul broker MQTT
e consentire l’autenticazione delle stazioni, anche in caso di failure
del server di backend, è utilizzabile il tool <strong>rmapctrl</strong> che deve
generere i seguenti file:</p>
<ul class="simple">
<li><p>file.pwd</p></li>
<li><p>aclfile</p></li>
<li><p>file.psk</p></li>
</ul>
<p>Una volta copiati i file in <strong>/etc/mosquitto/</strong> sul server di data
ingestion, è necessario effettuare un reload del servizio
<strong>mosquitto.service</strong> in modo che i file aggiornati vengano recepiti
correttamente; questo normalmente viene fatto solo in caso di modifica
degli stessi file.</p>
</div>
<div class="section" id="url">
<span id="mqtt-url-reference"></span><h4>URL<a class="headerlink" href="#url" title="Link a questa intestazione">¶</a></h4>
<p>Se le URLs configurate tornano HTTP status code == 2xx, allora la
authentication / authorization ha successo. Se lo status code == 4xx,
authentication / authorization fallisce. Per uno status code == 5xx o
server Unreachable, la richiesta HTTP sarà ritentata fino al raggiungimento di
http_retry_count. Se tutti i tentativi falliscono e nessun altro backend ha successo,
allora torna un errore e il client è disconnesso.</p>
<p>Configurazioni Mosquitto per il back-end http:</p>
<p>differenti modi di autenticare l'utente:</p>
<ul class="simple">
<li><p>auth_opt_http_getuser_uri /auth/auth</p></li>
<li><p>auth_opt_http_getuser_uri /auth/auth_sha</p></li>
<li><p>auth_opt_http_getuser_uri /auth/sha</p></li>
<li><p>auth_opt_http_getuser_uri /auth/pskkey</p></li>
</ul>
<p>verifica autorizzazioni:</p>
<ul class="simple">
<li><p>auth_opt_http_superuser_uri /auth/superuser</p></li>
<li><p>auth_opt_http_aclcheck_uri /auth/acl</p></li>
</ul>
</div>
</div>
<div class="section" id="broker-amqp">
<h3>Broker AMQP<a class="headerlink" href="#broker-amqp" title="Link a questa intestazione">¶</a></h3>
<p>Il brocker AMQP (rabbitmq) svolge queste funzioni principali:</p>
<ul class="simple">
<li><p>fornisce AMQP come protocollo per lo scambio dati</p></li>
<li><p>gestisce lo scambio interno dei messaggi sostanzialmente come
sistema di buffering persistente</p></li>
<li><p>gestisce accoglienza e autorizzazione relativamente a:
- dati in formato json (secondo specifiche RMAP)
- immagini georeferenziate
- configurazioni stazioni
mettendo poi a disposizione questi dati ad appositi archiviatori</p></li>
<li><p>mette a disposizione un sistema per lo scambio dati tra fornitori e
consumatori di dati (grosse moli di dati)</p></li>
</ul>
<p>Viene utilizzato un solo tipo di exchange: fanout</p>
<p><a class="reference internal" href="../_images/10000000000002BA000001CF10D58739AA10CEF3.png"><img alt="fanoutexchange" src="../_images/10000000000002BA000001CF10D58739AA10CEF3.png" style="width: 11.18cm; height: 7.334cm;" /></a></p>
<p>I producer inviano dati agli <strong>Exchange</strong> e i consumer li prelevano
dalle <strong>Queue</strong>.
La gestione e il monitoraggio del broker avviene tramite l’accesso
all’interfaccia web di RabbitMQ.
All’accesso viene visualizzata la dashboard con statistiche varie,
messaggi accodati, accodati, connessioni, ecc…</p>
<p><a class="reference internal" href="../_images/10000001000007600000037539E6A3FD1D30171B.png"><img alt="overview" src="../_images/10000001000007600000037539E6A3FD1D30171B.png" style="width: 14.986cm; height: 7.022cm;" /></a></p>
<p>Il numero di messaggi in stato <em>Ready</em> può essere un buon indicatore
in caso di problemi, se il numero cresce in maniera importante e i
messaggi non vengono scodati.</p>
<p>Nella sezione <strong>Exchanges</strong> è possibile
gestire quelli esistenti oppure configurarne di nuovi.</p>
<p><a class="reference internal" href="../_images/10000001000002F6000001694EE7486645E83327.png"><img alt="exchanges" src="../_images/10000001000002F6000001694EE7486645E83327.png" style="width: 10.589cm; height: 5.313cm;" /></a></p>
<p>Cliccando sul nome del Exchange si viene rimandati al dettaglio della
sua configurazione e alla definizione dei <strong>Bindings</strong>, ovvero dove
vengono indirizzati i messaggi pubblicati: la <strong>Queue</strong> di
destinazione</p>
<p>Exchanges → Queue</p>
<p>ad esempio:
rmap.mqtt.bufr.report_fixed → arpaer.out.bufr.report_fixed&amp;validated</p>
<p><a class="reference internal" href="../_images/100000010000034B00000253E938A43FC98A0D1A.png"><img alt="exchange" src="../_images/100000010000034B00000253E938A43FC98A0D1A.png" style="width: 10.292cm; height: 7.417cm;" /></a></p>
<p>Nella sezione <strong>Queues &amp; Streams</strong> vengono gestite e definite le code
di destinazione dei messaggi collezionati dal <strong>Exchange</strong>.</p>
<p>Qui posso controllare il numero di messaggi disponibili nella coda,
non ancora confermati, ecc…  Solitamente se tutto funziona
correttamente la coda dovrebbe risultare sempre vuota, in quanto il
<strong>consumer</strong> ha recuperato correttamente tutti i messaggi pubblicati.</p>
<p><a class="reference internal" href="../_images/10000001000006600000033B3F9646A30A7792D1.png"><img alt="queue" src="../_images/10000001000006600000033B3F9646A30A7792D1.png" style="width: 11.566cm; height: 6.343cm;" /></a></p>
<p>In questa sezione è possibile spostare i messaggi da una coda ad
un’altra (<strong>Move messages</strong>), cancellare definitivamente la coda e
tutti i suoi messaggi (<strong>Delete Queue</strong>) oppure cancellare tutti i
messaggi all'interno della coda (<strong>Purge Messages</strong>).</p>
<p>Nella sezione <strong>Admins</strong> vengono definiti gli utenti necessari solo al
broker AMQP e non utilizzati dal resto del sistema di
authenticazione. Questi saranno quindi solo fornitori e consumatori di
dati esterni.  Qui vengono definite le autorizzazioni dell'utente
secondo una precisa definizione di regexp. A esempio per l’utente
<strong>paperino</strong> sono le seguenti:</p>
<ul class="simple">
<li><p>virtual host utilizzato è il default, ovvero “ / ”</p></li>
<li><p>non ha permessi di configurazione (campo vuoto in fase di
definizione)</p></li>
<li><p>ha permessi di lettura e scrittura in tutto ciò (exchange e queue)
che inizia con il suo nome utente (<strong>^paperino..*</strong>), in cui potrà
leggere e pubblicare dati</p></li>
</ul>
<div class="section" id="definizione-nuovo-fornitore-o-consumatore-di-dati">
<h4>Definizione nuovo fornitore o consumatore di dati<a class="headerlink" href="#definizione-nuovo-fornitore-o-consumatore-di-dati" title="Link a questa intestazione">¶</a></h4>
<p>La definizione di un nuovo fornitore di dati o consumatore di dati è
ottenuta da:</p>
<ul class="simple">
<li><p>creazione utente con privilegi write e read con regular expression
<strong>^utente..*</strong></p></li>
<li><p>creazione queue con eventuale <em>Message TTL</em> (se vuoto è indefinito,
altrimenti imposta il valore massimo in millisecondi di permanenza dei
messaggi nella queue, una volta superato quel valore i messaggi
vengono rimossi)</p></li>
<li><p>creazione exchange con binding alla queue creata al punto precedente</p></li>
</ul>
</div>
<div class="section" id="nomenclatura-convenzionale">
<h4>Nomenclatura convenzionale<a class="headerlink" href="#nomenclatura-convenzionale" title="Link a questa intestazione">¶</a></h4>
<p>La sintassi utilizzata nella definizione di exchange e code è
autoesplicativa e basata sul punto come separatore tra campi</p>
<p>Fornitore:
-  <strong>exchange</strong> → <em>utente.in.formato.descrizione</em></p>
<p>Consumatore:
-  <strong>queue</strong> → <em>utente.out.formato.descrizione</em></p>
<p><em>utente</em> = nome utente definito in fase di creazione
<em>in/out</em> = direzione operazione (<em>in</em> per fornitore, <em>out</em> per consumatore)
<em>formato</em> = tipologia di output (es. json, xml, bufr)
<em>descrizione</em> = label descrittiva dei dati in transito</p>
<p>Ogni utente ha accesso in lettura e scrittura a exchange e code che
iniziano con il <strong>Name</strong> del proprio utente.</p>
<p>Nelle coda è definito il parametro <strong>Message TTL</strong> con un valore ad
esempio di 604800000 (millisecondi) pari a 7 giorni, per cui tutti i
messaggi pubblicati al suo interno rimarranno disponibili nella coda
per 7 giorni, i messaggi più vecchi rimossi automaticamente.</p>
</div>
<div class="section" id="sistema-di-autenticazione-e-autorizzazione-di-rmap">
<h4>Sistema di autenticazione e autorizzazione di RMAP<a class="headerlink" href="#sistema-di-autenticazione-e-autorizzazione-di-rmap" title="Link a questa intestazione">¶</a></h4>
<p>Il broker utilizza inoltre il sistema di autenticazione e
autorizzazione di RMAP per autenticare la ricezione di messaggi:</p>
<ul class="simple">
<li><p>fotografie: formato jpeg</p></li>
<li><p>configurazione stazioni: formato json</p></li>
</ul>
</div>
<div class="section" id="amqp-url-reference">
<span id="id1"></span><h4>URL<a class="headerlink" href="#amqp-url-reference" title="Link a questa intestazione">¶</a></h4>
<p>Autentica utente o amministratore:</p>
<ul class="simple">
<li><p>user_path     &quot;<a class="reference external" href="http://localhost/auth/user">http://localhost/auth/user</a>&quot;</p></li>
</ul>
<p>Sempre autorizzato tutti vhost:</p>
<ul class="simple">
<li><p>vhost_path    &quot;<a class="reference external" href="http://localhost/auth/vhost">http://localhost/auth/vhost</a>&quot;</p></li>
</ul>
<p>Autorizzate risorse che iniziano con un punto &quot;.&quot; e &quot;configuration&quot; o &quot;photo&quot;:</p>
<ul class="simple">
<li><p>resource_path &quot;<a class="reference external" href="http://localhost/auth/resource">http://localhost/auth/resource</a>&quot;</p></li>
</ul>
<p>Le successive verifiche di autenticazione vengono fatte dai daemon di
importazione dati che verificano che l'utente utilizzato per
l'autenticazione AMQP siano corrispondenti ai metadati dei dati
inviati.</p>
<p>Per fotografie e configurazioni questa attualmente è una metodologia
disattivata a vantaggio della metodologia HTTP.</p>
</div>
</div>
<div class="section" id="log">
<h3>Log<a class="headerlink" href="#log" title="Link a questa intestazione">¶</a></h3>
<p>Tutti i log relativi ai daemon coinvolti in RMAP si trovano nella directory <strong>/var/log/rmap/</strong>.</p>
</div>
<div class="section" id="descrizione-applicazioni-django">
<h3>Descrizione applicazioni Django<a class="headerlink" href="#descrizione-applicazioni-django" title="Link a questa intestazione">¶</a></h3>
<p>Il funzionamento del back-end e del front-end è garantito da una suite
di applicazioni Django</p>
<div class="section" id="stations-app">
<h4>stations app<a class="headerlink" href="#stations-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="descrizione">
<h5>Descrizione<a class="headerlink" href="#descrizione" title="Link a questa intestazione">¶</a></h5>
<p>Questa applicazione sovranintende alla gestione delle stazioni
gestendone la crezione, configurazione e aggiornamento dei metadati,
mantenedo aggiornati lo stato di funzionamento e autodiagnostica, le
versioni del firmware utilizzate, e le informazioni di autenticazione
e autorizzazione.</p>
</div>
<div class="section" id="database">
<h5>DataBase<a class="headerlink" href="#database" title="Link a questa intestazione">¶</a></h5>
<a class="reference internal image-reference" href="../_images/model_stations.png"><img alt="../_images/model_stations.png" src="../_images/model_stations.png" style="width: 100%;" /></a>
<div class="section" id="table-userprofile">
<h6>table UserProfile<a class="headerlink" href="#table-userprofile" title="Link a questa intestazione">¶</a></h6>
<p>relazione one to one con l'oggetto User del Django authentication system
utilizzato per estendere i metadati di un utente.</p>
</div>
<div class="section" id="table-stationmetadata">
<h6>table StationMetadata<a class="headerlink" href="#table-stationmetadata" title="Link a questa intestazione">¶</a></h6>
<p>Metadati principali di una stazione.
Identificativi che compongono la chieve univoca per il DataBase dati:</p>
<ul class="simple">
<li><p>ident: identificativo per stazioni mobili</p></li>
<li><p>lat/lon: coordinate</p></li>
<li><p>network: rete di stazioni omogenee a cui appartiene</p></li>
</ul>
<p>Identificativi univoci per il DataBase dati:</p>
<ul class="simple">
<li><p>user: utente</p></li>
<li><p>slug: identificativo sintetico della stazione</p></li>
</ul>
</div>
<div class="section" id="table-stationconstantdata">
<h6>table StationConstantdata<a class="headerlink" href="#table-stationconstantdata" title="Link a questa intestazione">¶</a></h6>
<p>Coppia btable,value che compongono i dati costanti di stazione.</p>
</div>
<div class="section" id="table-board">
<h6>table Board<a class="headerlink" href="#table-board" title="Link a questa intestazione">¶</a></h6>
<p>Board (moduli) che fanno parte di una stazione. Una Board prevede uno o più transporti di comunicazione,
uno o più sensori, uno stato di funzionamento e uno stato del firmware.</p>
</div>
<div class="section" id="table-transport">
<h6>table Transport*<a class="headerlink" href="#table-transport" title="Link a questa intestazione">¶</a></h6>
<p>Definiscono i paramtri di comunicazione per ogni trasporto.</p>
</div>
<div class="section" id="table-sensor">
<h6>table Sensor<a class="headerlink" href="#table-sensor" title="Link a questa intestazione">¶</a></h6>
<p>Sensori connessi a una board.
Identificativi che compongono la chiave univoca per il DataBase dati:</p>
<ul class="simple">
<li><p>level: livello rappresentativo delle misure</p></li>
<li><p>timernage: elaborazione statistica</p></li>
</ul>
<p>Definisce il driver utilizzato per il bus che bisogna utilizzare per
comunicare con il sensore insieme ad alcuni parametri per
identificarlo e per comunicare con lui.</p>
</div>
<div class="section" id="table-sensortype">
<h6>table SensorType<a class="headerlink" href="#table-sensortype" title="Link a questa intestazione">¶</a></h6>
<p>Definisce un tipo di sensore: il livello dei dati (sample o report) e
il tipo che determina il driver da utilizzare per comunicare con il
sensore. Ogni sensore può riportare più misure definite dalla tabelle btable.</p>
</div>
<div class="section" id="table-btable">
<h6>table Btable<a class="headerlink" href="#table-btable" title="Link a questa intestazione">¶</a></h6>
<p>Elenco dei Bcode della tabella B definita in modo univoco dalle
specifiche RMAP (tabella B WMO). Sono abbinati descrizione e unità di misura
prima e dopo un eventuale applicazione dei fattori di scala.</p>
</div>
<div class="section" id="table-boardmaintstatus">
<h6>table BoardMaintStatus<a class="headerlink" href="#table-boardmaintstatus" title="Link a questa intestazione">¶</a></h6>
<p>Definisce lo stato di una Board così come comunicati dalla stazione (Stima V4).
Prevede valori booleani e numerici.</p>
</div>
<div class="section" id="table-boardfirmwaremetadata">
<h6>table BoardFirmwareMetadata<a class="headerlink" href="#table-boardfirmwaremetadata" title="Link a questa intestazione">¶</a></h6>
<p>Mantiene uno stato aggiornato dei firmware delle board presenti in stazione.
Il campo mac viene utilizzato:</p>
<ul class="simple">
<li><p>valorizzato al primo tentativo di aggiornamento</p></li>
<li><p>verificato i successivi aggiornamenti</p></li>
<li><p>i restanti campi sono aggiornati solo se la verifica ha successo</p></li>
</ul>
<p>questo serve come semplice metodo di autenticazione della richiesta
http di aggiornamento del firmware delle board. Se l'hardware viene
cambiato a una stazione preesistente il mac deve essere resettato.</p>
</div>
<div class="section" id="table-stationmaintstatus">
<h6>table StationMaintStatus<a class="headerlink" href="#table-stationmaintstatus" title="Link a questa intestazione">¶</a></h6>
<p>Questa tabella viene aggiornata tramite la messaggistica a standard
RMAP nel root topic &quot;maint&quot; dei dati pubblicati MQTT. Mantiene la
versione del firmware di stazione (versione globale, solitamente della
board master), l'utimo aggiornamento della connessione e lo stato
della connessione.</p>
</div>
<div class="section" id="table-stationimage">
<h6>table StationImage<a class="headerlink" href="#table-stationimage" title="Link a questa intestazione">¶</a></h6>
<p>Associa ad ogni stazione delle fotografie con commenti e metadati
utili per dettagliare la sua collocazione e caratteristiche.</p>
</div>
</div>
<div class="section" id="id2">
<h5>URL<a class="headerlink" href="#id2" title="Link a questa intestazione">¶</a></h5>
<p>Sono riportate solo le versioni delle URL con tutti i parametri, anche omittibili</p>
<ul class="simple">
<li><p><strong>'^$'</strong> home page</p></li>
<li><p><strong>'^wizard/$'</strong>       wizard inizio configurazione stazione BASE (solo su stazione BASE)</p></li>
<li><p><strong>'^wizard2/$'</strong>      wizard seconda pagina configurazione stazione BASE (solo su stazione BASE)</p></li>
<li><p><strong>'^wizard_done/$'</strong>  wizard fine configurazione stazione BASE (solo su stazione BASE)</p></li>
<li><p><strong>'^wizard_error/$'</strong> wizard errore configurazione stazione BASE (solo su stazione BASE)</p></li>
<li><p><strong>'^admin/doc/'</strong>    documentatione admin di Django</p></li>
<li><p><strong>^admin/'</strong>         admin di Django</p></li>
<li><p><strong>'^registrazione/register/$'</strong>   pagina di registrazione utenti</p></li>
<li><p><strong>'^registrazione/'</strong>  radice di tutti i path necessari per la registrazione utenti</p></li>
<li><p><strong>'^auth/user'</strong>        autenticazione/autorizzazione rabbit-mq; guarda <a class="reference internal" href="#amqp-url-reference"><span class="std std-ref">amqp</span></a></p></li>
<li><p><strong>'^auth/vhost'</strong>       autenticazione/autorizzazione rabbit-mq; guarda <a class="reference internal" href="#amqp-url-reference"><span class="std std-ref">amqp</span></a></p></li>
<li><p><strong>'^auth/resource'</strong>    autenticazione/autorizzazione rabbit-mq; guarda <a class="reference internal" href="#amqp-url-reference"><span class="std std-ref">amqp</span></a></p></li>
<li><p><strong>'^auth/auth$'</strong>       autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^auth/auth_sha$'</strong>   autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^auth/sha$'</strong>        autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^auth/pskkey$'</strong>     autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^auth/superuser$'</strong>  autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^auth/acl$'</strong>        autenticazione/autorizzazione mosuiqtto; guarda <a class="reference internal" href="#mqtt-url-reference"><span class="std std-ref">mqtt</span></a></p></li>
<li><p><strong>'^accounts/profile/(?P&lt;mystation_slug&gt;[-w]+)/(?P&lt;stationimage_id&gt;[-w]+)/$'</strong>
pagina di amministrazione dell'utente/della stazione utente</p></li>
<li><p><strong>'^robots.txt$'</strong>   robots.txt per i motori di ricerca</p></li>
<li><p><strong>'^stations/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong> elenco
stazioni con metadati riassuntivi</p></li>
<li><p><strong>'^stationstatus/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong> elenco
stazioni con stato e autodiagnostica</p></li>
<li><p><strong>'^stationmqttmonitor/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong>
monitoraggio web della comunicazione MQTT</p></li>
<li><p><strong>'^stationsupload/json/$'</strong> upload della configurazione stazione se
l'utente è autenticato e se la stazione uplodata corrisponde
all'utente stesso (è il metodo attualmente utilizzato in sostituzione di AMQP)</p></li>
<li><p><strong>'^stationconfig/(?P&lt;user&gt;[-_w]+)/(?P&lt;station_slug&gt;[-_w]+)$'</strong> serie
di RPC per configurare una stazione in modalità &quot;notification&quot;</p></li>
<li><p><strong>'^stations/(?P&lt;user&gt;[-_w]+)/(?P&lt;station_slug&gt;[-_w]+)/json/$'</strong>
configurazione stazione in formato json; se l'utente è autenticato
il json è completo di password, nel caso contrario sono assenti; il
timerange viene completato con P2=mqttsampletime; da utilizzare per
la configurazione stazione</p></li>
<li><p><strong>'^stations/(?P&lt;user&gt;[-_w]+)/(?P&lt;station_slug&gt;[-_w]+)/json_dump/$'</strong>
dump della configurazione stazione in formato json; se l'utente è autenticato
il json è completo di password, nel caso contrario sono assenti; il
timerange non viene completato lasciando P2 per essere completato successivamente.</p></li>
<li><p><strong>'^stations/(?P&lt;user&gt;[-_w]+)/(?P&lt;station_slug&gt;[-_w]+)/configv3/$'</strong>
restituisce un file binario da utilizzare su SD card per la
configurazione stazioni Stima V3</p></li>
<li><p><strong>'^stations/(?P&lt;user&gt;[-_w]+)/(?P&lt;station_slug&gt;[-_w]+)/(?P&lt;board_slug&gt;[-_w]*)/json/$'</strong>
configurazione di una board di una stazione in formato json; se
l'utente è autenticato il json è completo di password, nel caso
contrario sono assenti; il timerange viene completato con
P2=mqttsampletime; da utilizzare per la configurazione stazione</p></li>
<li><p><strong>'^delstation/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong> cancellazione di una stazione</p></li>
<li><p><strong>'^stationlocaldata/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong> visualizza
i dati misurati dalla stazione StimaWiFi se risulta collegata nella
stessa rete locale con avahi/bonjour</p></li>
<li><p><strong>'^stationsonmap/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</strong> visualizza le
stazioni su mappa</p></li>
</ul>
</div>
</div>
<div class="section" id="network-app">
<h4>network app<a class="headerlink" href="#network-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id3">
<h5>Descrizione<a class="headerlink" href="#id3" title="Link a questa intestazione">¶</a></h5>
<p>Ogni stazione è associata a un network. In questa app viene
visualizzata la lista dei network e i metadati di ogni network.  Non
esiste un link automatico tra i network pubblicati dalle stazioni e i
network presenti in questa app.  Se lo stesso network è presente sia
nei dati che in questa app, i metadati presenti in questa app vengono
visualizzati quando richiesto.</p>
</div>
<div class="section" id="id4">
<h5>DataBase<a class="headerlink" href="#id4" title="Link a questa intestazione">¶</a></h5>
<img alt="../_images/model_network.png" src="../_images/model_network.png" />
</div>
<div class="section" id="id5">
<h5>URL<a class="headerlink" href="#id5" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p><strong>'^network/(?P&lt;name&gt;[-w]+)/$'</strong>    navigazione e visualizzazione network</p></li>
</ul>
</div>
</div>
<div class="section" id="http2mqtt-app">
<h4>http2mqtt app<a class="headerlink" href="#http2mqtt-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id6">
<h5>Descrizione<a class="headerlink" href="#id6" title="Link a questa intestazione">¶</a></h5>
<p>Questa app permette di pubblicare i dati tramite http.  Le specifiche
seguono le RMAP RFC per http con le specifiche a questo link
<a class="reference internal" href="../rmap_rfc/rfc.html#rmaprfc-http-reference"><span class="std std-ref">http2mqtt</span></a></p>
</div>
<div class="section" id="id7">
<h5>URL<a class="headerlink" href="#id7" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p><strong>'^http2mqtt/$'</strong></p></li>
</ul>
</div>
</div>
<div class="section" id="firmware-updater-e-firmware-updater-stima-app">
<h4>firmware_updater e firmware_updater_stima app<a class="headerlink" href="#firmware-updater-e-firmware-updater-stima-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id8">
<h5>Descrizione<a class="headerlink" href="#id8" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id9">
<h5>DataBase<a class="headerlink" href="#id9" title="Link a questa intestazione">¶</a></h5>
<img alt="../_images/model_firmware.png" src="../_images/model_firmware.png" />
<p>Le due tabelle differiscono per la versionatura del firmware in un
caso utilizzando un campo date e nell'altro revisione e versione.</p>
</div>
<div class="section" id="id10">
<h5>URL<a class="headerlink" href="#id10" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p>'^firmware/$', views.index, name='firmware_index'),</p></li>
<li><p>'^firmware/update/(?P&lt;name&gt;[-_w]+)/$', views.update, name='firmware_update'),</p></li>
<li><p>'^firmware/stima/v4/$'</p></li>
<li><p>'^firmware/stima/v4/update/(?P&lt;name&gt;[-_w]+)/$'</p></li>
</ul>
</div>
</div>
<div class="section" id="geoimage-app">
<h4>geoimage app<a class="headerlink" href="#geoimage-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id11">
<h5>Descrizione<a class="headerlink" href="#id11" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id12">
<h5>DataBase<a class="headerlink" href="#id12" title="Link a questa intestazione">¶</a></h5>
<img alt="../_images/model_geoimage.png" src="../_images/model_geoimage.png" />
</div>
<div class="section" id="id13">
<h5>URL<a class="headerlink" href="#id13" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p>'^geoimage/geoimagesonmap/(?P&lt;ident&gt;[-_w]+)/$'</p></li>
<li><p>'^geoimage/geoimagebyid/(?P&lt;id&gt;[-_w]+)/$'</p></li>
<li><p>'^geoimage/geoimagedelete/(?P&lt;id&gt;[-_w]+)/$'</p></li>
<li><p>'^geoimage/geoimagesbycoordinate/(?P&lt;lon&gt;[-_w.]+)/(?P&lt;lat&gt;[-_w.]+)/$'</p></li>
</ul>
</div>
</div>
<div class="section" id="rpc-app">
<h4>rpc app<a class="headerlink" href="#rpc-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id14">
<h5>Descrizione<a class="headerlink" href="#id14" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id15">
<h5>DataBase<a class="headerlink" href="#id15" title="Link a questa intestazione">¶</a></h5>
<img alt="../_images/model_rpc.png" src="../_images/model_rpc.png" />
</div>
<div class="section" id="id16">
<h5>URL<a class="headerlink" href="#id16" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p>'^rpcs/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</p></li>
<li><p>'^rpc/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/(?P&lt;id&gt;[-_w]+)/$'</p></li>
<li><p>'^rpc-submit-free/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</p></li>
<li><p>'^rpc-submit/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</p></li>
</ul>
</div>
</div>
<div class="section" id="ticket-app">
<h4>ticket app<a class="headerlink" href="#ticket-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id17">
<h5>Descrizione<a class="headerlink" href="#id17" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id18">
<h5>DataBase<a class="headerlink" href="#id18" title="Link a questa intestazione">¶</a></h5>
<img alt="../_images/model_ticket.png" src="../_images/model_ticket.png" />
</div>
<div class="section" id="id19">
<h5>URL<a class="headerlink" href="#id19" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p>'^tickets/(?P&lt;user&gt;[-_w]+)/(?P&lt;slug&gt;[-_w]+)/$'</p></li>
<li><p>'^ticket/(?P&lt;ticket&gt;[-_w]+)/$'</p></li>
<li><p>'^ticket_image/(?P&lt;image_id&gt;[-_w]+)/$'</p></li>
<li><p>'^ticket_attachment/(?P&lt;attachment_id&gt;[-_w]+)/$'</p></li>
<li><p>'^tickets_assigned/(?P&lt;user_ass&gt;[-_w]+)/$'</p></li>
<li><p>'^tickets_subscribed/(?P&lt;user_sub&gt;[-_w]+)/$'</p></li>
</ul>
</div>
</div>
<div class="section" id="borinud-app">
<h4>borinud app<a class="headerlink" href="#borinud-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id20">
<h5>Descrizione<a class="headerlink" href="#id20" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id21">
<h5>URL<a class="headerlink" href="#id21" title="Link a questa intestazione">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">basepattern</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;^borinud/api/v1/(?P&lt;format&gt;\w+)&#39;</span>
<span class="s1">&#39;/(?P&lt;ident&gt;\w+|\*|-)&#39;</span>
<span class="s1">&#39;/(?P&lt;coords&gt;(?P&lt;lon&gt;\-?\+?\d+|-),(?P&lt;lat&gt;\-?\+?\d+|-)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;network&gt;[-\w]+|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;trange&gt;(?P&lt;tr&gt;\d+|-|\*),(?P&lt;p1&gt;\d+|-|\*),(?P&lt;p2&gt;\d+|-|\*)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;level&gt;(?P&lt;lt1&gt;\d+|-|\*),(?P&lt;lv1&gt;\d+|-|\*),(?P&lt;lt2&gt;\d+|-|\*),(?P&lt;lv2&gt;\d+|-|\*)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;var&gt;B\d</span><span class="si">{5}</span><span class="s1">|\*)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>'^borinud/$'</p></li>
<li><p>basepattern + '/summaries/(?P&lt;year&gt;d{4})/(?P&lt;month&gt;d{2})/(?P&lt;day&gt;d{2})$'</p></li>
<li><p>basepattern + '/timeseries/(?P&lt;year&gt;d{4})/(?P&lt;month&gt;d{2})/(?P&lt;day&gt;d{2})/(?P&lt;hour&gt;d{2})$'</p></li>
<li><p>basepattern + '/spatialseries/(?P&lt;year&gt;d{4})/(?P&lt;month&gt;d{2})/(?P&lt;day&gt;d{2})/(?P&lt;hour&gt;d{2})$'</p></li>
<li><p>basepattern + '/stationdata$'</p></li>
<li><p>basepattern + '/stations$'</p></li>
</ul>
</div>
</div>
<div class="section" id="graphite-dballe-app">
<h4>graphite-dballe  app<a class="headerlink" href="#graphite-dballe-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id22">
<h5>Descrizione<a class="headerlink" href="#id22" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id23">
<h5>URL<a class="headerlink" href="#id23" title="Link a questa intestazione">¶</a></h5>
</div>
</div>
<div class="section" id="insertdata-app">
<h4>insertdata app<a class="headerlink" href="#insertdata-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id24">
<h5>Descrizione<a class="headerlink" href="#id24" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id25">
<h5>URL<a class="headerlink" href="#id25" title="Link a questa intestazione">¶</a></h5>
<ul class="simple">
<li><p>'^insertdata/image$'</p></li>
<li><p>'^insertdata/manualdata$'</p></li>
<li><p>'^insertdata/newstation$'</p></li>
<li><p>'^insertdata/stationmodify/(?P&lt;slug&gt;[-_w]+)/(?P&lt;bslug&gt;[-_w]+)/$'</p></li>
</ul>
</div>
</div>
<div class="section" id="showdata-app">
<h4>showdata app<a class="headerlink" href="#showdata-app" title="Link a questa intestazione">¶</a></h4>
<div class="section" id="id26">
<h5>Descrizione<a class="headerlink" href="#id26" title="Link a questa intestazione">¶</a></h5>
</div>
<div class="section" id="id27">
<h5>URL<a class="headerlink" href="#id27" title="Link a questa intestazione">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">basepattern</span> <span class="o">=</span> <span class="p">(</span>
<span class="s1">&#39;^showdata/(?P&lt;ident&gt;\w+|\*|-)&#39;</span>
<span class="s1">&#39;/(?P&lt;coords&gt;(?P&lt;lon&gt;\-?\+?\d+|-),(?P&lt;lat&gt;\-?\+?\d+|-)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;network&gt;[-\w]+|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;trange&gt;(?P&lt;tr&gt;\d+|-|\*),(?P&lt;p1&gt;\d+|-|\*),(?P&lt;p2&gt;\d+|-|\*)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;level&gt;(?P&lt;lt1&gt;\d+|-|\*),(?P&lt;lv1&gt;\d+|-|\*),(?P&lt;lt2&gt;\d+|-|\*),(?P&lt;lv2&gt;\d+|-|\*)|\*)&#39;</span>
<span class="s1">&#39;/(?P&lt;var&gt;B\d</span><span class="si">{5}</span><span class="s1">|\*)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>'^showdata/$'</p></li>
<li><p>basepattern + '/timeseries/(?P&lt;year&gt;d{4})/(?P&lt;month&gt;d{2})/(?P&lt;day&gt;d{2})/(?P&lt;hour&gt;d{2})$'</p></li>
<li><p>basepattern + '/spatialseries/(?P&lt;year&gt;d{4})/(?P&lt;month&gt;d{2})/(?P&lt;day&gt;d{2})$'</p></li>
<li><p>basepattern + '/stationdata$'</p></li>
<li><p>basepattern + '/stations$'</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="daemon">
<h3>Daemon<a class="headerlink" href="#daemon" title="Link a questa intestazione">¶</a></h3>
<p>Il daemon sono hanno i seguento comandi:
* run
* start
* stop</p>
<p>le altre opzioni sono documentate con l'opzione --help</p>
<ul class="simple">
<li><p>amqp2amqp_identvalidationd</p></li>
<li><p>amqp2amqp_jsonline2bufrd</p></li>
<li><p>amqp2arkimetd</p></li>
<li><p>amqp2dballed</p></li>
<li><p>amqp2djangod</p></li>
<li><p>amqp2geoimaged</p></li>
<li><p>amqp2mqttd</p></li>
<li><p>composereportd</p></li>
<li><p>dballe2arkimet</p></li>
<li><p>mqtt2amqpd</p></li>
<li><p>mqtt2dballed</p></li>
<li><p>mqtt2graphited</p></li>
<li><p>mqtt2stationmaintd</p></li>
<li><p>report2observationd</p></li>
<li><p>rpcd</p></li>
<li><p>stationd</p></li>
<li><p>ttn2dballed</p></li>
</ul>
</div>
<div class="section" id="tools">
<h3>Tools<a class="headerlink" href="#tools" title="Link a questa intestazione">¶</a></h3>
<p>Il tools disponibili sono:</p>
<ul class="simple">
<li><p>rmapgui</p></li>
<li><p>rmapweb</p></li>
<li><p>rmapctrl</p></li>
<li><p>rmap-explorer</p></li>
<li><p>rmap-configure</p></li>
</ul>
</div>
<div class="section" id="struttura-cartelle">
<h3>Struttura cartelle<a class="headerlink" href="#struttura-cartelle" title="Link a questa intestazione">¶</a></h3>
<dl class="simple">
<dt>arduino</dt><dd><p>obsolete library and formware for arduino SDK</p>
</dd>
<dt>arpae_aq_ckan_to_bufr</dt><dd><p>getter and importer from ARPAE ckan db for air quality data</p>
</dd>
<dt>doc</dt><dd><p>documentation source</p>
</dd>
<dt>fritzing</dt><dd><p>simple schematic and PCB for fritzing EDA</p>
</dd>
<dt>kicad</dt><dd><p>all Stima schematic and PCB for Kicad</p>
</dd>
<dt>luftdaten_to_bufr</dt><dd><p>getter and importer from luftdaten DB</p>
</dd>
<dt>mqtt2bufr</dt><dd><p>mqtt to bufr and vice versa following RMAP specification</p>
</dd>
<dt>pic</dt><dd><p>obsolete firmware for i2c-power pic version</p>
</dd>
<dt>pipe2dba</dt><dd><p>osolete importer from pipe</p>
</dd>
<dt>platformio</dt><dd><p>all Stima firmware project for platformio</p>
</dd>
<dt>python</dt><dd><p>python source code for RMAP server and tools</p>
</dd>
<dt>rabbitmq</dt><dd><p>saved configuration for rabbitmq broker</p>
</dd>
<dt>raspberry</dt><dd><p>obsolete software for Stima base raspberry version</p>
</dd>
<dt>rpm</dt><dd><p>rpm spec files to be updated</p>
</dd>
<dt>server</dt><dd><p>configuration files for RMAP server full version
(changed from default installation)</p>
</dd>
<dt>server-backend</dt><dd><p>configuration files for RMAP server backend only  version
(changed from default installation)</p>
</dd>
<dt>server-data-ingestion</dt><dd><p>configuration files for RMAP server data-ingestion only  version
(changed from default installation)</p>
</dd>
</dl>
</div>
<div class="section" id="id28">
<h3>Data ingestion<a class="headerlink" href="#id28" title="Link a questa intestazione">¶</a></h3>
<p>Da rimuove solo di riferimento per sphinx</p>
<p>Si possono consultare le <a class="reference internal" href="#dataingestion-reference"><span class="std std-ref">funzionalità</span></a></p>
</div>
</div>
<div class="section" id="installazione-server-completo-basato-su-rocky-linux-8">
<h2>Installazione server completo basato su  Rocky Linux 8<a class="headerlink" href="#installazione-server-completo-basato-su-rocky-linux-8" title="Link a questa intestazione">¶</a></h2>
<div class="section" id="installazione-sistema-operativo">
<h3>Installazione sistema operativo<a class="headerlink" href="#installazione-sistema-operativo" title="Link a questa intestazione">¶</a></h3>
<p>Installare Rocky Linux 8.</p>
<p>Aggiunta repository e installazione pacchetti</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">yum</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">copr</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">copr</span> <span class="n">enable</span> <span class="n">simc</span><span class="o">/</span><span class="n">stable</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">copr</span> <span class="n">enable</span> <span class="n">pat1</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enabled</span> <span class="n">powertools</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">copr</span> <span class="n">enable</span> <span class="n">simc</span><span class="o">/</span><span class="n">cosudo</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">rmap</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">django</span><span class="o">-</span><span class="n">dynamic</span><span class="o">-</span><span class="nb">map</span><span class="o">-</span><span class="n">borinud</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">mosquitto</span> <span class="n">mosquitto</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">plug</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">arkimet</span> <span class="n">dballe</span>
<span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">stunnel</span>
<span class="n">useradd</span> <span class="n">rmap</span>
</pre></div>
</div>
<p>/etc/selinux/config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELINUX</span><span class="o">=</span><span class="n">disabled</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/tmpfiles.d/rmap.conf">/etc/tmpfiles.d/rmap.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span>
<span class="n">chmod</span> <span class="n">go</span><span class="o">+</span><span class="n">rx</span> <span class="o">/</span><span class="n">rmap</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/sysconfig/crond">/etc/sysconfig/crond</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rmap</span><span class="p">:</span><span class="n">rmap</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rmap</span>
</pre></div>
</div>
<p>Generate ssl auto signed certificate</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>mkdir certs
cd certs

1 – Since we don’t have a certificate authority, we’ll create a local CA using SSL:
openssl genrsa -des3 -out ca.key 2048
enter a pass phrase with at least 4 characters. Remember it as it will be used several times.

2 – Then we’ll create a signing request for our local CA
openssl req -new -key ca.key -out ca.csr -sha256
Enter the same passphrase chosen in the previous step. It’s safe to leave all other fields empty, for the sake of our setup’s simplicity.

3 – Then we can create our CA root certificate, valid for 180 days:
openssl x509 -req -in ca.csr -signkey ca.key -out ca-root.crt -days 180 -sha256
Again, enter the preciously chosen passphrase when requested to do so

4 – We’ll then create our certificate key
openssl genrsa -out localhost.key 2048

5 – And using the key, we’ll create a certificate request:
openssl req -new -key localhost.key -out localhost.csr -sha256
Note: when being prompted for the “Common Name”, use “localhost”, as this will be the way we’ll reference the MQTT broker locally.
If you have a DNS entry pointing to the host server, you can use that too. All remaining fields can be left empty.

6 – Lastly, we’ll create the certificate, using the certificate request created in step 5 and the CA root certificate created in step 5, also valid for 180 days
openssl x509 -req -in mosquitto.csr -CA ca-root.crt -CAkey ca.key -CAcreateserial -out localhost.crt -days 180

When you’re done you should have the following files in the directory:

 ca-root.crt – Certificate authority root certificate
 ca.csr – Certificate authority certificate signing request
 ca.key – Certificate Authority certificate Key
 localhost.crt – Mosquitto certificate
 localhost.csr – Mosquitto certificate signing request
 localhost.key – Mosquitto certificate key
</pre></div>
</div>
</div>
<div class="section" id="firewall">
<h3>Firewall<a class="headerlink" href="#firewall" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">firwalld</span>
<span class="n">systemctrl</span> <span class="n">enable</span> <span class="n">firewalld</span>
<span class="n">systemctrl</span> <span class="n">start</span> <span class="n">firewalld</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">80</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">442</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">443</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">5925</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">1883</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">5671</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">5672</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">8883</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">8884</span><span class="o">/</span><span class="n">tcp</span>
<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">permanent</span> <span class="o">--</span><span class="n">zone</span><span class="o">=</span><span class="n">public</span> <span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">port</span><span class="o">=</span><span class="mi">15672</span><span class="o">/</span><span class="n">tcp</span>

<span class="n">firewall</span><span class="o">-</span><span class="n">cmd</span> <span class="o">--</span><span class="n">reload</span>
</pre></div>
</div>
</div>
<div class="section" id="postgresql">
<h3>postgresql<a class="headerlink" href="#postgresql" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">module</span> <span class="n">disable</span> <span class="n">postgresql</span><span class="p">:</span><span class="mi">10</span>
<span class="n">dnf</span> <span class="n">module</span> <span class="n">enable</span> <span class="n">postgresql</span><span class="p">:</span><span class="mi">12</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">server</span> <span class="n">postgresql</span><span class="o">-</span><span class="n">contrib</span> <span class="n">python3</span><span class="o">-</span><span class="n">psycopg2</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">postgresql</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">d</span><span class="o">/</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/systemd/system/postgresql.service.d/rmap.conf">/etc/systemd/system/postgresql.service.d/rmap.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span>
<span class="n">chown</span> <span class="n">postgres</span><span class="p">:</span><span class="n">postgres</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">pgsql</span><span class="o">/</span>
<span class="n">postgresql</span><span class="o">-</span><span class="n">setup</span> <span class="o">--</span><span class="n">initdb</span> <span class="o">--</span><span class="n">unit</span> <span class="n">postgresql</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/rmap/pgsql/data/pg_hba.conf">/rmap/pgsql/data/pg_hba.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/rmap/pgsql/data/postgresql.conf">/rmap/pgsql/data/postgresql.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">service</span>

<span class="n">su</span> <span class="o">-</span> <span class="n">postgres</span>
<span class="n">createuser</span> <span class="o">-</span><span class="n">P</span> <span class="o">-</span><span class="n">e</span> <span class="n">rmapadmin</span>
<span class="o">&lt;</span> <span class="n">insert</span> <span class="n">rmapadmin</span> <span class="k">as</span> <span class="n">password</span> <span class="o">&gt;</span>
<span class="n">createdb</span> <span class="o">--</span><span class="n">owner</span><span class="o">=</span><span class="n">rmapadmin</span> <span class="n">rmapadmin</span>
<span class="n">exit</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rmap/rmap-site.cfg">/etc/rmap/rmap-site.cfg</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rmap/dashboard.conf">/etc/rmap/dashboard.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rmap/graphTemplates.conf">/etc/rmap/graphTemplates.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmapctrl</span> <span class="o">--</span><span class="n">syncdb</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">su</span> <span class="o">-</span> <span class="n">postgres</span>
<span class="n">createuser</span> <span class="o">-</span><span class="n">P</span> <span class="o">-</span><span class="n">e</span> <span class="n">rmap</span>
<span class="o">&lt;</span> <span class="n">insert</span> <span class="n">rmap</span> <span class="k">as</span> <span class="n">password</span> <span class="o">&gt;</span>

<span class="n">createdb</span> <span class="o">--</span><span class="n">owner</span><span class="o">=</span><span class="n">rmap</span> <span class="n">report_fixed</span>
<span class="n">createdb</span> <span class="o">--</span><span class="n">owner</span><span class="o">=</span><span class="n">rmap</span> <span class="n">report_mobile</span>
<span class="n">createdb</span> <span class="o">--</span><span class="n">owner</span><span class="o">=</span><span class="n">rmap</span> <span class="n">sample_fixed</span>
<span class="n">createdb</span> <span class="o">--</span><span class="n">owner</span><span class="o">=</span><span class="n">rmap</span> <span class="n">sample_mobile</span>

<span class="n">exit</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbadb</span> <span class="n">wipe</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:&lt;password&gt;@localhost/report_fixed&quot;</span>
<span class="n">dbadb</span> <span class="n">wipe</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:&lt;password&gt;@localhost/report_mobile&quot;</span>
<span class="n">dbadb</span> <span class="n">wipe</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:&lt;password&gt;@localhost/sample_mobile&quot;</span>
<span class="n">dbadb</span> <span class="n">wipe</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:&lt;password&gt;@localhost/sample_fixed&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="apache">
<h3>apache<a class="headerlink" href="#apache" title="Link a questa intestazione">¶</a></h3>
<p>Collect static files from django apps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">global_static</span>
<span class="n">rmapctrl</span> <span class="o">--</span><span class="n">collectstatic</span>
<span class="n">rmdir</span> <span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">global_static</span>
</pre></div>
</div>
<dl class="simple">
<dt>::</dt><dd><p>dnf install python3-mod_wsgi
dnf install mod_security mod_security_crs
dnf install mod_ssl</p>
</dd>
</dl>
<dl>
<dt>::</dt><dd><p>useradd -r rmap
mkdir /home/rmap
chown rmap:rmap /home/rmap
mkdir /rmap/cache
chown rmap:rmap /rmap/cache
mkdir  /usr/share/rmap/media
chown rmap:rmap  /usr/share/rmap/media</p>
<p>cp -r ~/certs /etc/httpd
chown -R apache /etc/httpd/certs</p>
</dd>
</dl>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/conf.modules.d/00-mpm.conf">/etc/httpd/conf.modules.d/00-mpm.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/conf.d/rmap.conf">/etc/httpd/conf.d/rmap.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/conf.d/rmap.inc">/etc/httpd/conf.d/rmap.inc</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/conf.d/ssl.conf">/etc/httpd/conf.d/ssl.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/modsecurity.d/crs-setup.conf">/etc/httpd/modsecurity.d/crs-setup.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/httpd/modsecurity.d/local_rules/modsecurity_localrules.conf">/etc/httpd/modsecurity.d/local_rules/modsecurity_localrules.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chkconfig</span> <span class="n">httpd</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">httpd</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="stunnel">
<h3>Stunnel<a class="headerlink" href="#stunnel" title="Link a questa intestazione">¶</a></h3>
<p>Create file with psk keys:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmapctrl</span> <span class="o">--</span><span class="n">exportmqttpsk</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">stunnel</span><span class="o">/</span><span class="n">file</span><span class="o">.</span><span class="n">psk</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/stunnel/stunnel.conf">/etc/stunnel/stunnel.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/cron.d/stunnel_presharedkey">/etc/cron.d/stunnel_presharedkey</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chkconfig</span> <span class="n">stunnel</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">stunnel</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="arkimet">
<h3>Arkimet<a class="headerlink" href="#arkimet" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">arkimet</span> <span class="n">arkimet</span><span class="o">-</span><span class="n">postprocessor</span><span class="o">-</span><span class="n">suite</span>
<span class="n">useradd</span>  <span class="o">-</span><span class="n">r</span> <span class="n">arkimet</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">arkimet</span>
<span class="n">chown</span> <span class="n">arkimet</span><span class="p">:</span><span class="n">arkimet</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">arkimet</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">arkimet</span><span class="o">/</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">arkimet</span><span class="p">:</span><span class="n">rmap</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">arkimet</span><span class="o">/</span>
<span class="n">chmod</span> <span class="o">-</span><span class="n">R</span> <span class="n">g</span><span class="o">+</span><span class="n">w</span>  <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">arkimet</span><span class="o">/</span>
</pre></div>
</div>
<p>oppure:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rmap</span><span class="p">:</span><span class="n">rmap</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">arkimet</span><span class="o">/</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">arkimet</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">arkimet</span><span class="p">:</span><span class="n">arkimet</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">arkimet</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/sysconfig/arkimet">/etc/sysconfig/arkimet</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/arkimet/scan/bufr_generic_mobile_rmap.py">/etc/arkimet/scan/bufr_generic_mobile_rmap.py</a></p>
<p>Replicate structure in:</p>
<p><a class="reference external" href="https://github.com/r-map/rmap/tree/master/server/rmap/arkimet">/rmap/arkimet</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">chkconfig</span> <span class="n">arkimet</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">arkimet</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="mosquitto">
<h3>Mosquitto<a class="headerlink" href="#mosquitto" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">mosquitto</span>
<span class="n">chown</span> <span class="n">mosquitto</span><span class="p">:</span><span class="n">mosquitto</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">mosquitto</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/mosquitto/conf.d/rmap.conf">/etc/mosquitto/conf.d/rmap.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/mosquitto/aclfile">/etc/mosquitto/aclfile</a></p>
<p>remove everythings and add in /etc/mosquitto/mosquitto.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include_dir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
<span class="n">pid_file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">.</span><span class="n">pid</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">~/</span><span class="n">certs</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">mosquitto</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">certs</span>

<span class="n">touch</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">pwfile</span>
<span class="n">chkconfig</span> <span class="n">mosquitto</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">mosquitto</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="rabbitmq">
<h3>Rabbitmq<a class="headerlink" href="#rabbitmq" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packagecloud</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">rpm</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span><span class="n">bash</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packagecloud</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">erlang</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">rpm</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">bash</span>

<span class="n">dnf</span> <span class="n">install</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rabbitmq/enabled_plugins">/etc/rabbitmq/enabled_plugins</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rabbitmq/rabbitmq-env.conf">/etc/rabbitmq/rabbitmq-env.conf</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/rabbitmq/rabbitmq.config">/etc/rabbitmq/rabbitmq.config</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">~/</span><span class="n">certs</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rabbitmq</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">certs</span>

<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">mnesia</span><span class="o">/</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rabbitmq</span><span class="p">:</span><span class="n">rabbitmq</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">rabbitmq</span>
<span class="n">chkconfig</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">start</span>
</pre></div>
</div>
<p>login at management interface with user &quot;guest&quot; and password &quot;guest&quot;
on overview page use import definition to configure exchange, queue and users
with the same management interface remove &quot;guest&quot; user and login with a new real user</p>
<p>Per attivare uno showell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rabbitmqctl</span> <span class="n">set_parameter</span> <span class="n">shovel</span> <span class="n">report_mobile</span> <span class="s1">&#39;{&quot;src-protocol&quot;: &quot;amqp091&quot;, &quot;src-uri&quot;: &quot;amqp://rmap:&lt;password&gt;@rmap.cc&quot;, &quot;src-queue&quot;: &quot;report_mobile_saved&quot;, &quot;dest-protocol&quot;: &quot;amqp091&quot;, &quot;dest-uri&quot;: &quot;amqp://rmap:&lt;password&gt;@&quot;, &quot;dest-queue&quot;: &quot;report_mobile&quot;}&#39;</span>
</pre></div>
</div>
<p>problema non risolto:
se si trasferiscono dati scritti da un utente autenticandosi con un altro utente la security su user_id lo vieta.
<a class="reference external" href="https://www.rabbitmq.com/shovel-dynamic.html">https://www.rabbitmq.com/shovel-dynamic.html</a>
bisognerebbe riuscire a settare &quot;user_id&quot; tramite il parametro &quot;dest-publish-properties&quot; nel formato json sopra ma non funziona</p>
</div>
<div class="section" id="monit">
<h3>Monit<a class="headerlink" href="#monit" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">monit</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/monitrc">/etc/monitrc</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/monit.d/rmap">/etc/monit.d/rmap</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/usr/local/bin/check_mosquitto">/usr/local/bin/check_mosquitto</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chkconfig</span> <span class="n">monit</span> <span class="n">on</span>
<span class="n">service</span> <span class="n">monit</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="cron">
<h3>Cron<a class="headerlink" href="#cron" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">dballe</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rmap</span><span class="p">:</span><span class="n">rmap</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">dballe</span>
</pre></div>
</div>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/cron.d/dballe2arkimet">/etc/cron.d/dballe2arkimet</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/cron.d/luftdaten">/etc/cron.d/luftdaten</a></p>
<p>Opzionali per provider esterni con appositi convertitori:</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/cron.d/arpae_aq_ckan">/etc/cron.d/arpae_aq_ckan</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server/etc/cron.d/makeexplorer">/etc/cron.d/makeexplorer</a></p>
</div>
<div class="section" id="sincronizzazione-db-da-un-server">
<h3>Sincronizzazione DB da un server<a class="headerlink" href="#sincronizzazione-db-da-un-server" title="Link a questa intestazione">¶</a></h3>
<div class="section" id="server-di-origine">
<h4>Server di origine<a class="headerlink" href="#server-di-origine" title="Link a questa intestazione">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmapctrl</span> <span class="o">--</span><span class="n">dumpdata</span> <span class="o">&gt;</span> <span class="n">dumpdata</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<p>rimuovere le prime righe che non sono json</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbadb</span> <span class="n">export</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;mysql:///report_fixed?user=rmap&amp;password=****&quot;</span> <span class="o">&gt;</span> <span class="n">report_fixed</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="n">export</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;mysql:///report_mobile?user=rmap&amp;password=****&quot;</span> <span class="o">&gt;</span> <span class="n">report_mobile</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="n">export</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;mysql:///sample_fixed?user=rmap&amp;password=****&quot;</span> <span class="o">&gt;</span> <span class="n">sample_fixed</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="n">export</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;mysql:///sample_mobile?user=rmap&amp;password=****&quot;</span> <span class="o">&gt;</span> <span class="n">sample_mobile</span><span class="o">.</span><span class="n">bufr</span>
</pre></div>
</div>
</div>
<div class="section" id="server-di-destinazione">
<h4>Server di destinazione<a class="headerlink" href="#server-di-destinazione" title="Link a questa intestazione">¶</a></h4>
<p>Da interfaccia web admin rimuovere TUTTI gli utenti (compreso rmap)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmapctrl</span> <span class="o">--</span><span class="n">loaddata</span><span class="o">=</span><span class="n">dumpdata</span><span class="o">.</span><span class="n">json</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbadb</span> <span class="kn">import</span> <span class="o">--</span><span class="n">wipe</span><span class="o">-</span><span class="n">first</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:***@localhost/report_fixed&quot;</span> <span class="n">report_fixed</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="kn">import</span> <span class="o">--</span><span class="n">wipe</span><span class="o">-</span><span class="n">first</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:***@localhost/report_mobile&quot;</span> <span class="n">report_mobile</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="kn">import</span> <span class="o">--</span><span class="n">wipe</span><span class="o">-</span><span class="n">first</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:***@localhost/sample_mobile&quot;</span> <span class="n">sample_mobile</span><span class="o">.</span><span class="n">bufr</span>
<span class="n">dbadb</span> <span class="kn">import</span> <span class="o">--</span><span class="n">wipe</span><span class="o">-</span><span class="n">first</span> <span class="o">--</span><span class="n">dsn</span><span class="o">=</span><span class="s2">&quot;postgresql://rmap:***@localhost/sample_fixed&quot;</span> <span class="n">sample_fixed</span><span class="o">.</span><span class="n">bufr</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">rmap</span><span class="o">/</span>
<span class="n">rsync</span> <span class="o">-</span><span class="n">av</span> <span class="n">utente</span><span class="nd">@serverorigine</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">media</span> <span class="o">.</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="arkiweb">
<h3>Arkiweb<a class="headerlink" href="#arkiweb" title="Link a questa intestazione">¶</a></h3>
<p>AL MOMENTO NON DISPONIBILE !</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="n">install</span> <span class="n">arkiweb</span>
</pre></div>
</div>
<p>/etc/httpd/conf.d/arkiweb.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ScriptAlias</span> <span class="o">/</span><span class="n">services</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span>
<span class="n">Alias</span> <span class="o">/</span><span class="n">arkiweb</span>  <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">arkiweb</span>

<span class="o">&lt;</span><span class="n">Directory</span> <span class="s2">&quot;/usr/lib64/arkiweb&quot;</span><span class="o">&gt;</span>
       <span class="n">AllowOverride</span> <span class="kc">None</span>
       <span class="n">Options</span> <span class="o">+</span><span class="n">ExecCGI</span>

       <span class="n">Order</span> <span class="n">allow</span><span class="p">,</span><span class="n">deny</span>
       <span class="n">Allow</span> <span class="kn">from</span> <span class="nn">all</span>

       <span class="c1"># ARKIWEB_CONFIG is mandatory!</span>
       <span class="n">SetEnv</span> <span class="n">ARKIWEB_CONFIG</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">arkimet</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">.</span><span class="n">config</span>


       <span class="n">Require</span> <span class="nb">all</span> <span class="n">granted</span>

       <span class="c1"># Authentication (optional)</span>
       <span class="c1">#</span>
       <span class="c1"># Basic authentication example:</span>
       <span class="c1"># SetEnv ARKIWEB_RESTRICT REMOTE_USER</span>
       <span class="c1"># AuthType Basic</span>
       <span class="c1"># AuthUserFile /etc/arkiweb.passwords</span>
       <span class="c1"># require valid-user</span>
<span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

<span class="n">Alias</span> <span class="o">/</span><span class="n">arkiwebjs</span><span class="o">/</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span><span class="n">public</span><span class="o">/</span>
<span class="o">&lt;</span><span class="n">Directory</span> <span class="s2">&quot;/usr/share/arkiweb/public&quot;</span><span class="o">&gt;</span>
          <span class="c1">#Require all granted</span>
          <span class="n">AllowOverride</span> <span class="kc">None</span>

          <span class="n">Order</span> <span class="n">allow</span><span class="p">,</span><span class="n">deny</span>
          <span class="n">Allow</span> <span class="kn">from</span> <span class="nn">all</span>

          <span class="n">Require</span> <span class="nb">all</span> <span class="n">granted</span>

<span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span>
<span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">arkiweb</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>/rmap/arkimet/arkiweb.config</p>
</div>
</div>
<div class="section" id="installazione-server-solo-funzionalita-data-ingestion-basato-su-rocky-linux-8">
<h2>Installazione server solo funzionalità DATA INGESTION basato su  Rocky Linux 8<a class="headerlink" href="#installazione-server-solo-funzionalita-data-ingestion-basato-su-rocky-linux-8" title="Link a questa intestazione">¶</a></h2>
<div class="section" id="id29">
<h3>Installazione sistema operativo<a class="headerlink" href="#id29" title="Link a questa intestazione">¶</a></h3>
<p>Installare Rocky Linux 8.</p>
<p>Aggiunta repository e installazione pacchetti</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dnf</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">epel</span><span class="o">-</span><span class="n">release</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="n">yum</span><span class="o">-</span><span class="n">plugin</span><span class="o">-</span><span class="n">copr</span>
<span class="n">dnf</span> <span class="n">copr</span> <span class="n">enable</span> <span class="n">simc</span><span class="o">/</span><span class="n">stable</span>
<span class="n">dnf</span> <span class="n">copr</span> <span class="n">enable</span> <span class="n">pat1</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">dnf</span> <span class="n">config</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="nb">set</span><span class="o">-</span><span class="n">enabled</span> <span class="n">powertools</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="n">python3</span><span class="o">-</span><span class="n">rmap</span><span class="o">-</span><span class="n">core</span>
<span class="n">dnf</span> <span class="n">install</span> <span class="n">mosquitto</span> <span class="n">mosquitto</span><span class="o">-</span><span class="n">auth</span><span class="o">-</span><span class="n">plug</span>
<span class="n">useradd</span> <span class="n">rmap</span>
</pre></div>
</div>
<p>modificare il file /etc/selinux/config:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELINUX</span><span class="o">=</span><span class="n">disabled</span>
</pre></div>
</div>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/tmpfiles.d/rmap.conf">/etc/tmpfiles.d/rmap.conf</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span>
<span class="n">chmod</span> <span class="n">go</span><span class="o">+</span><span class="n">rx</span> <span class="o">/</span><span class="n">rmap</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rmap</span><span class="p">:</span><span class="n">rmap</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">rmap</span>
</pre></div>
</div>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/rmap/rmap-site.cfg">/etc/rmap/rmap-site.cfg</a></p>
<p>cambiare la password dell'utente amministratore.</p>
</div>
<div class="section" id="id30">
<h3>Mosquitto<a class="headerlink" href="#id30" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">mosquitto</span>
<span class="n">chown</span> <span class="n">mosquitto</span><span class="p">:</span><span class="n">mosquitto</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">mosquitto</span>
</pre></div>
</div>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/mosquitto/conf.d/rmap.conf">/etc/mosquitto/conf.d/rmap.conf</a></p>
<p>cancellare tutto il contenuto del file /etc/mosquitto/mosquitto.conf e sostituirlo con le seguenti righe:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">include_dir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span>
<span class="n">pid_file</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">/</span><span class="n">mosquitto</span><span class="o">.</span><span class="n">pid</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">systemctl</span> <span class="n">enable</span> <span class="n">mosquitto</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">mosquitto</span>
</pre></div>
</div>
</div>
<div class="section" id="id31">
<h3>Rabbitmq<a class="headerlink" href="#id31" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packagecloud</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">rpm</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span><span class="n">bash</span>
<span class="n">curl</span> <span class="o">-</span><span class="n">s</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">packagecloud</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">install</span><span class="o">/</span><span class="n">repositories</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">erlang</span><span class="o">/</span><span class="n">script</span><span class="o">.</span><span class="n">rpm</span><span class="o">.</span><span class="n">sh</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">bash</span>

<span class="n">dnf</span> <span class="n">install</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/rabbitmq/enabled_plugins">/etc/rabbitmq/enabled_plugins</a></p>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/rabbitmq/rabbitmq-env.conf">/etc/rabbitmq/rabbitmq-env.conf</a></p>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/rabbitmq/rabbitmq.config">/etc/rabbitmq/rabbitmq.config</a></p>
<p>Installare il certificato ssl/tls per il dominio del server in:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">arpaecert</span><span class="o">/</span><span class="n">arpae_it</span><span class="o">-</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">pem</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">arpaecert</span><span class="o">/</span><span class="n">arpae_it</span><span class="o">-</span><span class="n">mosquitto</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>e impostare gli opportuni privilegi di lettura/scrittura.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">mosquitto</span> <span class="n">mosquitto</span> <span class="mi">6849</span>  <span class="mi">1</span> <span class="n">dic</span> <span class="mf">14.23</span> <span class="n">arpae_it</span><span class="o">-</span><span class="n">mosquitto</span><span class="o">.</span><span class="n">pem</span>
<span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">rabbitmq</span>  <span class="n">rabbitmq</span>  <span class="mi">6849</span> <span class="mi">20</span> <span class="n">nov</span> <span class="mf">10.49</span> <span class="n">arpae_it</span><span class="o">-</span><span class="n">rabbitmq</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">/</span><span class="n">mnesia</span><span class="o">/</span>
<span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">rabbitmq</span><span class="p">:</span><span class="n">rabbitmq</span> <span class="o">/</span><span class="n">rmap</span><span class="o">/</span><span class="n">rabbitmq</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<p>effettuare il login all'interfaccia di management web: &lt;<a class="reference external" href="http://server-fqdn:15672/">http://server-fqdn:15672/</a>&gt;
con user &quot;guest&quot; e password &quot;guest&quot;, quindi utilizzare la funzione &quot;import definition&quot; per caricare exchange, queue e users importando il seguente file:</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/rabbitmq/rabbit_server_data_ingestion.json">rabbit_server_data_ingestion.json</a></p>
<p>dalla stessa interfaccia di management web impostare le password per tutti gli utenti, rimuovere l'utente &quot;guest&quot; e fare login con uno dei nuovi utenti definiti.</p>
</div>
<div class="section" id="id32">
<h3>Monit<a class="headerlink" href="#id32" title="Link a questa intestazione">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">monit</span>
</pre></div>
</div>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/monitrc">/etc/monitrc</a></p>
<p>scaricare il file <a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-data-ingestion/etc/monit.d/rmap">/etc/monit.d/rmap</a></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chmod</span> <span class="mi">0700</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">monitrc</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">monit</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">chown</span> <span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">monitrc</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">monit</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rmap</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">monit</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">monit</span>
</pre></div>
</div>
</div>
<div class="section" id="sincronizzazione-file-statici-per-autenticazione-e-autorizzazione-da-un-server-rmap-backend">
<h3>Sincronizzazione file statici per autenticazione e autorizzazione da un server RMAP backend<a class="headerlink" href="#sincronizzazione-file-statici-per-autenticazione-e-autorizzazione-da-un-server-rmap-backend" title="Link a questa intestazione">¶</a></h3>
<div class="section" id="id33">
<h4>Server di origine<a class="headerlink" href="#id33" title="Link a questa intestazione">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rmapctrl</span> <span class="o">--</span><span class="n">exportsha</span> <span class="o">&gt;</span> <span class="n">file</span><span class="o">.</span><span class="n">pwd</span>
<span class="n">rmapctrl</span> <span class="o">--</span><span class="n">exportmqttsha</span> <span class="o">&gt;&gt;</span> <span class="n">file</span><span class="o">.</span><span class="n">pwd</span>
<span class="n">rmapctrl</span> <span class="o">--</span><span class="n">exportmqttacl</span> <span class="o">&gt;</span> <span class="n">aclfile</span>
<span class="n">rmapctrl</span> <span class="o">--</span><span class="n">exportmqttpsk</span> <span class="o">&gt;</span> <span class="n">file</span><span class="o">.</span><span class="n">psk</span>
</pre></div>
</div>
<p>eventualmente rimuovere le prime righe di messaggistica del logging</p>
</div>
<div class="section" id="id34">
<h4>Server di destinazione<a class="headerlink" href="#id34" title="Link a questa intestazione">¶</a></h4>
<p>Trasferire i file in /etc/mosquitto/ sul nostro server per la data ingestion.
Imparire il comando:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">systemctl</span> <span class="n">reload</span> <span class="n">mosquitto</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="installazione-server-rmap-solo-funzionalita-backend-basato-su-rocky-linux-8-a-seervizio-per-la-data-ingestion-su-un-altra-macchina">
<h2>Installazione server RMAP solo funzionalità BACKEND basato su Rocky Linux 8 (a seervizio per la data ingestion su un'altra macchina)<a class="headerlink" href="#installazione-server-rmap-solo-funzionalita-backend-basato-su-rocky-linux-8-a-seervizio-per-la-data-ingestion-su-un-altra-macchina" title="Link a questa intestazione">¶</a></h2>
<p>Questi file sono specializzati per un server di solo backend:</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-backend/etc/httpd/conf.d/rmap.inc">/etc/httpd/conf.d/rmap.inc</a></p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-backend/etc/httpd/modsecurity.d/crs-setup.conf">/etc/httpd/modsecurity.d/crs-setup.conf</a></p>
<p>In questi due file sostituire la stringa &lt;insert IP of data-ingestion machine&gt; con quanto indicato.</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/r-map/rmap/master/server-backend/etc/monit.d/rmap">/etc/monit.d/rmap</a></p>
<div class="section" id="servizi">
<h3>Servizi<a class="headerlink" href="#servizi" title="Link a questa intestazione">¶</a></h3>
<p>Disabilitare mosquitto.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../videotutorial/videotutorial.html" class="btn btn-neutral float-right" title="Videotutorial" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../stima_wifi/testa_prelievo/testa_prelievo.html" class="btn btn-neutral float-left" title="Testa di prelievo per sensori Air Quality" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, CC BY-SA 4.0, Arpae https://www.arpae.it.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>