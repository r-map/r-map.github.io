

<!DOCTYPE html>
<html class="writer-html5" lang="it" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Obiettivo del documento &mdash; RMAP e Stima 3 documentazione</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/translations.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Indice" href="../genindex.html" />
    <link rel="search" title="Cerca" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> RMAP e Stima
          

          
            
            <img src="../_static/logo_stima.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../rmap_rfc/rfc.html">RFC rmap versione 3.3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../obsolete/index.html">Stima obsolete</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_v3/stima_v3.html">Stima V3</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_v4/stima_v4.html">Stima V4</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stima_wifi/index.html">Stima WiFi</a></li>
<li class="toctree-l1"><a class="reference internal" href="server_rmap.html">Server RMAP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../videotutorial/videotutorial.html">Videotutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dispense/index.html">Dispense</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">RMAP e Stima</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Obiettivo del documento</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/server_rmap/output.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>Handover RMAP</p>
<div class="section" id="obiettivo-del-documento">
<h1>Obiettivo del documento<a class="headerlink" href="#obiettivo-del-documento" title="Link a questa intestazione">¶</a></h1>
<p>Il presente documento ha lo scopo di raccogliere le informazioni
principali fornite durante gli incontri di formazione, principalmente
relativi alla gestione sistemistica dell’attuale infrastruttura, tenuti
dall’attuale referente del progetto RMAP di Arpae SIMC, P.Patruno.</p>
<p>Nella sezione <a class="reference external" href="#4.Linkutili|outline">Link utili</a> sono disponibili i
riferimenti sia alla documentazione del progetto RMAP che alla
documentazione ufficiale dei componenti principali da cui è costituito.</p>
</div>
<div class="section" id="server">
<h1><strong>Server</strong><a class="headerlink" href="#server" title="Link a questa intestazione">¶</a></h1>
<p>Riportiamo di seguito la lista dei server che compongono
l’infrastruttura RMAP, al momento ospitata presso il datacenter Arpae
SIMC a Parma, oltre ad un diagramma di funzionamento condiviso da
P.Patruno, inserito nel paragrafo successivo:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 24%" />
<col style="width: 25%" />
<col style="width: 25%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Hostname</p></td>
<td><p>IP (interno)</p></td>
<td><p>IP (pubblico)</p></td>
<td><p>Note</p></td>
</tr>
<tr class="row-even"><td><p>rmap8-test
.arpaepr.local</p></td>
<td><p>172.19.99.210</p></td>
<td><p>test.rmap.cc
[
89.39.237.156]</p></td>
<td><p>Server di test</p></td>
</tr>
<tr class="row-odd"><td><p>rmap8
.arpaepr.local</p></td>
<td><p>172.19.99.211</p></td>
<td><p>rmap.cc
[
89.39.237.157]</p></td>
<td><p>Server
produzione per
C
rowdsourcing*</p></td>
</tr>
<tr class="row-even"><td><p>rmap8-devel
.arpaepr.local</p></td>
<td><p>172.19.99.212</p></td>
<td><p>port forward
da
rmap.arpae.it,
alias
dati2.ARPAE.IT
[
89.39.237.155]</p></td>
<td><p>Server
produzione
(data
ingestion)</p></td>
</tr>
<tr class="row-odd"><td><p>rmap8-backend
.arpaepr.local</p></td>
<td><p>172.19.99.213</p></td>
<td><p>proxy 80 443
da
rmap.arpae.it,
alias
dati2.ARPAE.IT
[
89.39.237.155]</p></td>
<td><p>Server
produzione
(backend)</p></td>
</tr>
</tbody>
</table>
<p>* gestisce esclusivamente dati che non siano istituzionali (gestiti da
Arpae), per esempio scuole, progetti esterni, e così via.</p>
<div class="section" id="data-ingestion">
<h2>Data ingestion<a class="headerlink" href="#data-ingestion" title="Link a questa intestazione">¶</a></h2>
<p>Corrisponde al server attualmente denominato
<strong>rmap8-devel.arpaepr.local</strong>.</p>
<p>Assolve esclusivamente alla funzione di data ingestion.</p>
<p><a class="reference internal" href="../_images/100000000000071300000497357B495E6611DF88.png"><img alt="image0" src="../_images/100000000000071300000497357B495E6611DF88.png" style="width: 16.979cm; height: 10.686cm;" /></a></p>
<p>I dati che arrivano dalle stazioni meteo vengono autorizzati, tramite
meccanismo di autenticazione, e vengono inseriti in una coda dedicata
dal broker AMQP.</p>
<p>Le stazioni meteo sono suddivise in due macro gruppi:</p>
<ul class="simple">
<li><p><strong>stazioni Stima V3</strong>: comunicano in GSM in chiaro, tramite
protocollo MQTT con il broker MQTT (mosquitto)</p></li>
<li><p><strong>stazioni Stima V4</strong>: comunicano in TLS con PSK (Pre-Shared Key),
tramite protocollo MQTT TLS (PSK) con il broker MQTT (mosquitto)</p></li>
</ul>
<p>Il broker MQTT (mosquitto) è in grado di gestire direttamente le PSK
però le stazioni hanno bisogno di ricevere alcune informazioni, per
esempio la configurazione della stazione stessa, fornita non solo da
mosquitto ma anche da apache (demone httpd che è attivo solo sul server
di backend).</p>
<p>Mosquitto comunica tramite un terzo protocollo MQTTS (MQTT con SSL/TLS
su Websocket) utilizzato per funzionalità di monitoraggio delle stazioni
meteo: gli operatori che gestiscono le varie stazioni meteo possono
attivare in loco, tramite un semplice broker (MQTTS su Websocket), il
monitoraggio su websocket per verificare i messaggi pubblicati dalla
stazione sul broker (per ovviare all’assenza di un <strong>consumer</strong>
dedicato).</p>
<p>Tutte le porte su cui è in ascolto il broker di Mosquitto sono esposte
in quanto devono essere raggiungibili dalle varie stazioni meteo per
pubblicare (Stima V3 e Stima V4) oppure per il monitoraggio. Rimandiamo
alla sezioni <a class="reference external" href="#3.Porteeprotocolli|outline">Porte e Protocolli</a> per
un riepilogo delle varie porte utilizzate.</p>
<p>A pieno regime, RMAP sfrutterebbe 4 demoni che gestiscono 4 diverse
tipologie di stazioni-pubblicazioni:</p>
<ul class="simple">
<li><p>stazioni fisse che pubblicano report</p></li>
<li><p>stazioni mobili che pubblicano report</p></li>
<li><p>stazioni fisse che pubblicano campionamenti (sample)</p></li>
<li><p>stazioni mobili che pubblicano campionamenti (sample)</p></li>
</ul>
<p>Nell’attuale istanza RMAP in uso per Arpae è presente e attivo un solo
demone (<strong>mqtt2ampqd</strong>) che legge i messaggi da MQTT e li pubblicano su
delle code configurate su RabbitMQ (per stazioni fisse che pubblicano
report).</p>
<p>E’ presente anche un altro demone (<strong>report2observationd</strong>) che effettua
una trasformazione dei messaggi che arrivano inizialmente compressi, li
decomprime e li pubblica nuovamente, per cui arrivano sul broker MQTT in
forma decompressa.</p>
<p>I due demoni sono gestiti e avviati tramite <strong>monit</strong> in maniera
automatica.</p>
<p>In <strong>/etc/monit.d/</strong> è presente il file di configurazione per l’istanza
RMAP (denominato <strong>rmap</strong>). All’interno del file di configurazione di
<strong>monit</strong> risultano decommentate le righe relative a:</p>
<ul class="simple">
<li><p>controllo del processo del demone <strong>report2observationd</strong> ed
eventuale riavvio nel caso non sia attivo</p></li>
<li><p>controllo di mosquitto, con verifica della porta <strong>1883</strong> di
<strong>mosquitto</strong>; se non risponde su quella porta viene riavviato il
servizio</p></li>
<li><p>controllo del processo <strong>mqtt2ampqd_report_fixed_v1</strong> (gestito dal
demone <strong>mqtt2ampqd</strong>); se non presente avvia il processo in
automatico con i parametri di avvio (es. versione rmap, percorso del
file pid, percorso file log, ecc...)</p></li>
</ul>
<p>I file di configurazione (es. per <strong>monit</strong>) ma anche per le altre
entità configurate (es. <strong>rabbitmq</strong> e <strong>mqtt</strong>) sono pubblicati anche
su git, all’interno del progetto indicato nella sezione <a class="reference external" href="#4.Linkutili|outline">Link
utili</a>.</p>
<p>E’ possibile verificare lo stato dei servizi gestiti tramite monit,
eseguendo il comando <strong>monit status</strong>, collegandosi in ssh sul server.</p>
<p>Il broker Mosquitto (MQTT) è configurato tramite autenticazione, in modo
da autorizzare chi può fare cosa: ogni stazione può pubblicare solamente
sul topic mqtt per cui è stata configurata, in base a latitudine e
longitudine. Il meccanismo di autenticazione non viene gestito
direttamente da mosquitto ma da un componente esterno di autenticazione
a cui il servizio mosquitto manda la richiesta ogni volta che una
stazione prova ad autenticarsi.</p>
<p>Il servizio di autenticazione, gestito dal server di backend
(<strong>rmap8-backend.arpaepr.local</strong>) si basa su apache (<strong>httpd</strong>), nel
caso in cui non sia disponibile, il servizio di autenticazione ricade su
un file statico. Il file statico, utilizzato come sistema di
autenticazione di backup, viene sincronizzato tramite procedura
schedulata descritta nella sezione <a class="reference external" href="#3.Scriptsync|outline">Script
sync</a>, dal server di backend verso il server
di data ingestion (componente principale che deve sempre essere
disponibile) in modo da consentire comunque l’autenticazione delle
stazioni anche in caso di failure del backend (il sistema non consentirà
per esempio l’aggiunta o lo spostamento di stazioni ma non si bloccherà
la pubblicazione dei dati).</p>
<p>I dati, una volta autenticate le stazioni sul backend e pubblicati
tramite il broker MQTT, finiscono nelle code (Queue) di RabbiMQ. Da qui
poi i dati pubblicati vengono prelevati da un servizio Arpae
(sottoscritto ad una coda dedicata su RabbitMQ, <strong>publish-subscribe</strong>)
che li trasferisce nel proprio archivio.</p>
<div class="section" id="rabbitmq">
<h3>RabbitMQ<a class="headerlink" href="#rabbitmq" title="Link a questa intestazione">¶</a></h3>
<p>L’uso di RabbitMQ sul server di data ingestion è piuttosto semplice e
basato su interfaccia web (plugin attivato per RabbitMQ). Riportiamo di
seguito un diagramma di esempio, anche se nell’istanza RMAP in uso per
Arpae, al momento, non sono previste nemmeno le <strong>Routes</strong>, per cui
l’implementazione si basa esclusivamente su <strong>Exchanges → Queue</strong>:</p>
<p><a class="reference internal" href="../_images/10000000000002BA000001CF10D58739AA10CEF3.png"><img alt="image1" src="../_images/10000000000002BA000001CF10D58739AA10CEF3.png" style="width: 11.18cm; height: 7.334cm;" /></a>I messaggi vengono pubblicati all’interno dell’<strong>Exchange</strong>
e poi prelevati dalla <strong>Queue</strong> in cui sono stati inseriti.</p>
<p>L’accesso all’interfaccia web di RabbitMQ per la data ingestion è
disponibile al seguente url (tramite vpn e credenziali di amministratore
in possesso di Arpae):</p>
<p><a class="reference external" href="http://rmap8-devel.arpaepr.local:15672/">http://rmap8-devel.arpaepr.local:15672</a></p>
<p>All’accesso viene visualizzata la dashboard con statistiche varie,
messaggi pronti, connessioni, ecc…</p>
<p><a class="reference internal" href="../_images/10000001000007600000037539E6A3FD1D30171B.png"><img alt="image2" src="../_images/10000001000007600000037539E6A3FD1D30171B.png" style="width: 14.986cm; height: 7.022cm;" /></a></p>
<p>Il numero di messaggi in stato <em>Ready</em> può essere un buon indicatore in
caso di problemi, se il numero cresce in maniera importante e i messaggi
non vengono scodati, significa che potrebbe esserci un problema lato
client (per esempio Arpae) che non sta andando a recuperare i dati
pubblicati nella propria coda.</p>
<p>Nella sezione <strong>Exchanges</strong> (entità AMQP a cui vengono inviati i
messaggi e li instradano in zero o più code) è possibile gestire quelli
esistenti oppure configurarne di nuovi.</p>
<p><a class="reference internal" href="../_images/10000001000002F6000001694EE7486645E83327.png"><img alt="image3" src="../_images/10000001000002F6000001694EE7486645E83327.png" style="width: 10.589cm; height: 5.313cm;" /></a>Sono presenti alcuni <strong>Exchange</strong> creati di default all’avvio
di RabbitMQ che sono rimasti ma che in realtà non vengono utilizzati
(denominati <strong>amq.*</strong>). Quelli creati per l’istanza in uso da Arpae
sono denominati <strong>rmap.mqtt.*</strong> (sono stati definiti i 4 <strong>Exchange</strong>
completi, ma come indicato in precedenza è attivo solo quello relativo a
report per stazioni fisse) e <strong>cae.*</strong>.</p>
<p>Cliccando sul nome del Exchange si viene <a class="reference internal" href="../_images/100000010000034B00000253E938A43FC98A0D1A.png"><img alt="image4" src="../_images/100000010000034B00000253E938A43FC98A0D1A.png" style="width: 10.292cm; height: 7.417cm;" /></a>rimandati al
dettaglio della sua configurazione, allo stato di
pubblicazione/sottoscrizione dei messaggi, alla pubblicazione dei
messaggi o cancellazione del <strong>Exchange</strong> e più importante alla
definizione dei <strong>Bindings</strong>, ovvero dove vengono indirizzati i messaggi
pubblicati (la <strong>Queue</strong> di destinazione da impostare in fase di
configurazione del <strong>Exchange</strong> nel caso in cui i dati debbano essere
intercettati):</p>
<p>Exchanges → Queue</p>
<p>rmap.mqtt.bufr.report_fixed → arpaer.out.bufr.report_fixed&amp;validated</p>
<p>Nella sezione <strong>Queues &amp; Streams</strong> vengono gestite e definite le code di
destinazione dei messaggi collezionati dal <strong>Exchange</strong>.</p>
<p>Qui posso controllare il numero di messaggi disponibili, il totale, ecc…
Solitamente se tutto funziona correttamente la coda dovrebbe risultare
sempre vuota, in quanto il <strong>consumer</strong> (per esempio Arpae) ha
recuperato correttamente tutti i messaggi pubblicati, svuotando quindi
la <strong>Queue</strong>.</p>
<p><a class="reference internal" href="../_images/10000001000006600000033B3F9646A30A7792D1.png"><img alt="image5" src="../_images/10000001000006600000033B3F9646A30A7792D1.png" style="width: 11.566cm; height: 6.343cm;" /></a>In questa sezione è possibile spostare i messaggi da una coda
ad un’altra (<strong>Move messages</strong>), cancellare definitivamente la coda e
tutti i suoi messaggi (<strong>Delete Queue</strong>) oppure cancellare tutti i
messaggi all'interno della coda (<strong>Purge Messages</strong>). Ad ogni coda è
associato un servizio e una direzione, secondo una nomenclatura
specifica.</p>
<p>Nella sezione <strong>Admins</strong> vengono definiti gli utenti e il loro livello
di accesso (secondo una precisa definizione di regexp). Per l’utente
<strong>arpaepr</strong> sono le seguenti:</p>
<ul class="simple">
<li><p>virtual host utilizzato nell’istanza Arpae è il default, ovvero “ / ”</p></li>
<li><p>non ha permessi di configurazione (campo vuoto in fase di
definizione)</p></li>
<li><p>ha permessi di lettura e scrittura in tutto ciò (exchange e queue)
che inizia con il suo nome utente (<strong>^arpaer..*</strong>), in cui potrà
leggere e pubblicare dati</p></li>
</ul>
</div>
<div class="section" id="definizione-nuovo-utente">
<h3>Definizione nuovo utente<a class="headerlink" href="#definizione-nuovo-utente" title="Link a questa intestazione">¶</a></h3>
<p>La definizione di un nuovo external provider (<strong>consumer</strong>) è composta
da:</p>
<ul class="simple">
<li><p>creazione utente con privilegi write e read con regular expression
<strong>^utente..*</strong></p></li>
<li><p>creazione queue con eventuale <em>Message TTL</em> (se vuoto è indefinito,
altrimenti imposta il valore massimo in secondi di permanenza dei
messaggi nella queue, una volta superato quel valore i messaggi
vengono cancellati e sono irrecuperabili)</p></li>
<li><p>creazione exchange con binding alla queue creata al punto precedente</p></li>
</ul>
<p>La sintassi utilizzata nella definizione di exchange e code è
autoesplicativa e basata sul nome definito per l’utente (<strong>consumer</strong>):</p>
<ul class="simple">
<li><p><strong>exchange</strong> → <em>utente.in.formato.descrizione</em></p></li>
<li><p><strong>queue</strong> → <em>utente.out.formato.descrizione</em></p></li>
</ul>
<p><em>utente</em> = nome utente definito in fase di creazione</p>
<p><em>in/out</em>= direzione operazione (<em>in</em> per exchange, <em>out</em> per queue)</p>
<p><em>formato</em>= tipologia di output (es. json, xml, bufr)</p>
<p><em>descrizione</em>= label descrittiva del processo</p>
<p>Ogni utente ha accesso in lettura e scrittura a exchange e code che
iniziano con il <strong>Name</strong> del proprio utente.</p>
<p>Per CAE è stato attivato un exchange, al momento della redazione del
presente documento ancora in fase sperimentale, in cui CAE pubblica dei
dati (<strong>cae.in.jsonline.arpaer</strong>) che vengono poi inseriti nella queue
associata a quel exchange (<strong>arpaer.out.jsonline.rete_cae_arpaer</strong>) in
cui il consumer è Arpae che se li va a leggere (il nome della coda
rispetta il regexp <strong>^arpaer..*</strong> che la rende disponibile all’utente
<strong>arpaer</strong>). In questa coda è definito il parametro <strong>Message TTL</strong> con
un valore di 604800000 (secondi) pari a 7 giorni, per cui tutti i
messaggi pubblicati al suo interno rimarranno disponibili nella coda per
7 giorni, superata tale soglia la coda verrà ripulita e i dati persi
definitivamente.</p>
</div>
</div>
<div class="section" id="backend">
<h2>Backend<a class="headerlink" href="#backend" title="Link a questa intestazione">¶</a></h2>
<p>Corrisponde al server attualmente denominato
<strong>rmap8-backend.arpaepr.local</strong>.</p>
<p>Assolve principalmente alla funzione di autenticazione delle stazioni,
oltre che alle seguenti funzioni/servizi (di cui riportiamo, oltre allo
stato, anche il riferimento alla documentazione
<a class="reference external" href="#4.1.DocumentazioneRMAP(globale)|outline">online</a>):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#configurazione-delle-stazioni">Configurazione delle
stazioni</a>
(presente e attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#registrazione-utenti">Registrazione
utenti</a>
(presente e NON attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#visualizzazione-dei-dati">Visualizzazione dei
dati</a>
(presente e attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#cosudo">Cosudo</a>
(presente e NON attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#inserimento-manuale-dei-dati">Inserimento manuale dei
dati</a>
(presente e NON attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#rainbo">RainBO</a>
(presente e NON attivo)</p></li>
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html#interfaccia-web">Interfaccia
web</a>
(presente e attivo)</p></li>
</ul>
</div>
</div>
<div class="section" id="script-sync">
<h1>Script sync<a class="headerlink" href="#script-sync" title="Link a questa intestazione">¶</a></h1>
<p>Per mantenere allineato il processo di autenticazione sul broker MQTT e
consentire l’autenticazione delle stazioni, anche in caso di failure del
server di backend, è stato implementato un job pianificato ogni ora che
copia dal server di backend (<strong>rmap8-backend</strong>) verso il server di data
ingestion (<strong>rmap8-devel</strong>), i seguenti file:</p>
<ul class="simple">
<li><p>file.pwd</p></li>
<li><p>aclfile</p></li>
<li><p>file.psk</p></li>
</ul>
<p>Una volta copiati i file in <strong>/etc/mosquitto/</strong> sul server di data
ingestion, lo script effettua un reload del servizio
<strong>mosquitto.service</strong> in modo che i file aggiornati vengano recepiti
correttamente. In caso di errore durante reload del servizio di
mosquitto viene inviata una mail a <a class="reference external" href="mailto:sistemi&#37;&#52;&#48;yacme&#46;com">sistemi<span>&#64;</span>yacme<span>&#46;</span>com</a>.</p>
</div>
<div class="section" id="log">
<h1>Log<a class="headerlink" href="#log" title="Link a questa intestazione">¶</a></h1>
<p>I log relativi ai processi coinvolti in RMAP (<strong>mqtt2ampqd</strong> e
<strong>report2observationd</strong>) si trovano nella directory <strong>/var/log/rmap/</strong>.</p>
<p>Il file di log relativo allo script di sincronizzazione (su
<strong>rmap8-devel</strong>) viene scritto in <strong>/root/script_sync_backend/logs/</strong> e
viene ripulito e ricreato quando la sua dimensione supera i 2MB.</p>
</div>
<div class="section" id="porte-e-protocolli">
<h1><strong>Porte e protocolli</strong><a class="headerlink" href="#porte-e-protocolli" title="Link a questa intestazione">¶</a></h1>
<p>Vengono indicate di seguito le porte e relativi servizi in uso per RMAP:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
<col style="width: 15%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Porta</p></td>
<td><p>Pro
tocollo</p></td>
<td><p>Server</p></td>
<td><p>S
ervizio</p></td>
<td><p>Rmap
Server</p></td>
<td><p>Rmap
Data
In
gestion</p></td>
<td><p>Rmap
Backend</p></td>
</tr>
<tr class="row-even"><td><p>80</p></td>
<td><p>HTTP</p></td>
<td><p>apache</p></td>
<td><p>d
ownload
conf e
f
irmware
(Stima
V3)</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-odd"><td><p>442</p></td>
<td><p>HTTPS
TLS con
pre
shared
Key</p></td>
<td><p>stunnel</p></td>
<td><p>d
ownload
conf e
f
irmware
(Stima
v4)</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-even"><td><p>443</p></td>
<td><p>HTTPS
(S
SL/TLS)</p></td>
<td><p>apache</p></td>
<td><p>g
estione
backend
e
v
isualiz
zazione
dati</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-odd"><td><p>5925</p></td>
<td><p>HTTP</p></td>
<td><p>monit</p></td>
<td><p>monit
oraggio
demoni
RMAP</p></td>
<td><p>X</p></td>
<td></td>
<td><p>X</p></td>
</tr>
<tr class="row-even"><td><p>1883</p></td>
<td><p>MQTT</p></td>
<td><p>mo
squitto</p></td>
<td><p>pubbli
cazioni
dati
s
tazione
(Stima
V3)</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>5671</p></td>
<td><p>AMQPS
(S
SL/TLS)</p></td>
<td><p>ra
bbit-mq</p></td>
<td><p>pubbli
cazione
e
distri
buzione
dati</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>5672</p></td>
<td><p>AMQP</p></td>
<td><p>ra
bbit-mq</p></td>
<td><p>pubbli
cazione
e
distri
buzione
dati</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>8883</p></td>
<td><p>MQTTS
TLS con
pre
shared
Key</p></td>
<td><p>mo
squitto</p></td>
<td><p>pubbli
cazione
s
tazioni
(Stima
V4)</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>8884</p></td>
<td><p>MQTTS
(S
SL/TLS)
WE
BSOCKET</p></td>
<td><p>mo
squitto</p></td>
<td><p>monit
oraggio
MQTT da
web</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>15672</p></td>
<td><p>HTTP</p></td>
<td><p>ra
bbit-mq</p></td>
<td><p>Man
agement
Plugin</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
<td><p>X</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="best-practice-e-possibili-criticita">
<h1><strong>Best practice e possibili criticità</strong><a class="headerlink" href="#best-practice-e-possibili-criticita" title="Link a questa intestazione">¶</a></h1>
<p>Vengono indicate di seguito le principali criticità di funzionamento da
abbinare ad eventuali richieste di funzionamento, riportate da P.Patruno
in base alle esperienze affrontate durante gli anni:</p>
<ul class="simple">
<li><p>Down dell'intero sistema</p>
<ul>
<li><ul>
<li><p>può causare un ritardo nell’acquisizione dei dati da MQTT ed
eventuale intasamento di dati alla riattivazione (70 invii
contemporanei di una consistente mole di dati); i dati
aumentano ogni 15 minuti</p></li>
<li><p>(non dovrebbe mai accadere) può comportare l’ipotetica perdita
di dati in acquisizione da external provider tramite AMQP
(dipende da come gestisce l'invio il provider)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Rottura/malfunzionamento del servizio autenticazione sul backend</p>
<ul>
<li><ul>
<li><p>in caso di rottura/malfunzionamento può comportare la caduta
dell'autenticazione su file statico (backup statico sulla vm di
data ingestion) che rimane immutabile fino a ripristino</p></li>
<li><p>se il backend rimane in funzione può presentarsi come
situazione estrema, ma molto estrema, la dissociazione tra le
configurazioni in stazione e le configurazioni sul server di
data ingestion con possibile perdita di dati relativa solo alle
modifiche fatte nel backend</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Rottura/malfunzionamento del broker AMQP</p>
<ul>
<li><ul>
<li><p>può comportare la perdita di dati acquisizione da MQTT che sono
recuperabili tramite l’esecuzione di complesse remote procedure
call (RPC) sulle stazioni oppure fisicamente dalle SDcard in
loco sulla stazione</p></li>
<li><p>può comportare la perdita di dati acquisizione da external
provider AMQP (dipende da come gestisce l'invio l'external
provider)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Rottura/malfunzionamento del broker MQTT</p>
<ul>
<li><ul>
<li><p>può comportare un ritardo nell’acquisizione dati da MQTT ed
eventuale intasamento di dati alla riattivazione (70 invii
contemporanei di una consistente mole di dati); i dati
aumentano ogni 15 minuti</p></li>
<li><p>può comportare la perdita di dati acquisizione da MQTT che sono
recuperabili tramite l’esecuzione di complesse remote procedure
call (RPC) sulle stazioni oppure fisicamente dalle SDcard in
loco sulla stazione</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Rottura/malfunzionamento dei demoni mqtt2amqp</p>
<ul>
<li><ul>
<li><p>può comportare la perdita di dati acquisizione da MQTT che sono
recuperabili tramite l’esecuzione di complesse remote procedure
call (RPC) sulle stazioni oppure fisicamente dalle SDcard in
loco sulla stazione</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Di seguito le best practice suggerite da P.Patruno nel caso in cui si
presentino alcune delle anomalie indicate in precedenza:</p>
<ul class="simple">
<li><p><strong>S</strong><em>***pegnimento server*</em></p>
<ul>
<li><ul>
<li><p>prima spegnere server rmap8-devel (data ingestion) e poi
spegnere server rmap8-backend (backend)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Accensione server</p>
<ul>
<li><ul>
<li><p>accendere prima il server rmap8-backend (backend) e
successivamente il server rmap8-devel (data ingestion)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Sequenza spegnimento servizi vari</p>
<ul>
<li><ul>
<li><p>(facoltativo) se fosse possibile disattivare per prime le porte
di rete esterne, spegnendo le connessioni dall'esterno come
prima attività (al momento NON attivo)</p></li>
<li><p>broker MQTT (mosquitto.service)</p></li>
<li><p>demoni</p></li>
<li><p>broker AMQP (rabbitmq-server.service)</p></li>
<li><p>backend (httpd e postgres)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Sequenza avvio servizi vari</p>
<ul>
<li><ul>
<li><p>backend (httpd e postgres)</p></li>
<li><p>broker AMQP (rabbitmq-server.service)</p></li>
<li><p>demoni</p></li>
<li><p>broker MQTT (mosquitto.service)</p></li>
<li><p>(facoltativo) se fosse possibile attivare per ultime le porte
di rete esterne, attivando le connessioni dall'esterno solo a
sistema completamente avviato (al momento NON attivo)</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Riduzione del danno in caso di rottura/malfunzionamento di una delle
componenti</p>
<ul>
<li><ul>
<li><p>malfunzionamento/rottura autenticazione → disattivare tutto il
backend</p></li>
<li><p>malfunzionamento broker MQTT → disattivare broker MQTT (o porte
di rete esterne)</p></li>
<li><p>malfunzionamento/rottura broker AMQP → disattivare broker MQTT
(o porte di rete esterne)</p></li>
<li><p>malfunzionamento/rottura demoni → disattivare broker MQTT (o
porte di rete esterne)</p></li>
</ul>
</li>
</ul>
</li>
<li><p><strong>A</strong><em>***vvio o riavvio manuale processi*</em></p>
<ul>
<li><ul>
<li><p>il consiglio è utilizzare monit, già configurato per il riavvio
automatico dei servizi</p></li>
<li><p><em>monit status</em>: mostra la lista dei processi gestiti da monit e
il loro stato</p></li>
<li><p><em>monit start/restart &lt;nome_processo&gt;</em>: consente di
avviare/riavviare manualmente un processo tra quelli gestiti da
monit</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="link-utili">
<h1><strong>Link utili</strong><a class="headerlink" href="#link-utili" title="Link a questa intestazione">¶</a></h1>
<div class="section" id="documentazione-rmap-globale">
<h2>Documentazione RMAP (globale)<a class="headerlink" href="#documentazione-rmap-globale" title="Link a questa intestazione">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://doc.rmap.cc/">https://doc.rmap.cc/</a></p></li>
</ul>
</div>
<div class="section" id="documentazione-sistemistica-rmap-e-github">
<h2>Documentazione sistemistica RMAP e Github<a class="headerlink" href="#documentazione-sistemistica-rmap-e-github" title="Link a questa intestazione">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://doc.rmap.cc/server_rmap/server_rmap.html">https://doc.rmap.cc/server_rmap/server_rmap.html</a></p></li>
<li><p><a class="reference external" href="https://github.com/r-map/rmap/tree/master/doc/sphinx/server_rmap">https://github.com/r-map/rmap/tree/master/doc/sphinx/server_rmap</a></p></li>
</ul>
</div>
<div class="section" id="documentazione-ufficiale-rabbitmq">
<h2>Documentazione ufficiale RabbitMQ<a class="headerlink" href="#documentazione-ufficiale-rabbitmq" title="Link a questa intestazione">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://www.rabbitmq.com/docs">https://www.rabbitmq.com/docs</a></p></li>
<li><p><a class="reference external" href="https://www.rabbitmq.com/tutorials/amqp-concepts">https://www.rabbitmq.com/tutorials/amqp-concepts</a></p></li>
</ul>
</div>
<div class="section" id="documentazione-ufficiale-mosquitto">
<h2>Documentazione ufficiale Mosquitto<a class="headerlink" href="#documentazione-ufficiale-mosquitto" title="Link a questa intestazione">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://mosquitto.org/documentation/">https://mosquitto.org/documentation/</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, CC BY-SA 4.0, Arpae https://www.arpae.it.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>